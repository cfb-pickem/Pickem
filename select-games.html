<script type="module">
  import initNav from './js/nav.js';
  import { supabase } from './js/supabaseClient.js';

  const weekSel  = document.getElementById('week-select');
  const statusEl = document.getElementById('status');
  const tbody    = document.getElementById('games-body');
  const saveBtn  = document.getElementById('save-btn'); // kept, but no longer used

  let rows = [];       // current games for selected week
  let original = {};   // GameId -> { line, picked, week }

  function status(msg,isErr=false){
    statusEl.className = 'text-sm ' + (isErr ? 'text-red-300' : 'text-gray-300');
    statusEl.textContent = msg;
  }

  async function gatekeep(){
    await initNav();

    const { data: { user }, error } = await supabase.auth.getUser();
    if(error){ status(error.message,true); return false; }
    if(!user){ status('Please sign in to continue.', true); lock(); return false; }

    const { data, error: tErr } = await supabase
      .from('teams')
      .select('commissioner')
      .eq('user_id', user.id)
      .eq('commissioner', true);

    if(tErr){ status(tErr.message, true); lock(); return false; }
    if(!data || data.length === 0){ status('Access denied — commissioner only.', true); lock(); return false; }

    return true;
  }

  function lock(){ weekSel.disabled = true; saveBtn.disabled = true; }

  async function loadWeeks(){
    status('Loading weeks…');

    const { data: weekRows, error: wErr } = await supabase.rpc('get_distinct_weeks');
    if (wErr) { status(wErr.message, true); return false; }

    const weeks = (weekRows || []).map(r => r.week);
    if (weeks.length === 0) { status('No weeks found in all_games.', true); return false; }

    weekSel.innerHTML = weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
    weekSel.value = String(weeks[weeks.length - 1]);
    return true;
  }

  function niceTime(ts){
    if(!ts) return '';
    try{
      const d = new Date(ts);
      return d.toLocaleString('en-US', { weekday:'short', hour:'2-digit', minute:'2-digit' });
    }catch{ return ''; }
  }

  async function loadWeek(){
    const week = Number(weekSel.value);
    if(!Number.isFinite(week)){ status('Select a week.'); return; }
    status(`Loading week ${week} games…`);

    const { data, error } = await supabase
      .from('all_games')
      .select('GameId, Away, Home, "Start (CT)", line, picked, week')
      .eq('week', week)
      .order('GameId', { ascending: true });

    if(error) return status(error.message,true);

    rows = data || [];
    original = {};
    for(const r of rows){
      original[r.GameId] = { line: r.line, picked: !!r.picked, week: r.week };
    }
    renderTable();
    status(`Week ${week} loaded.`);
  }

  // --- NEW: update exactly one row by GameId with only changed fields ---
  async function updateRow(gameId, patch){
    // No-op if patch doesn’t actually change anything vs snapshot
    const snap = original[gameId] || {};
    const effective = {};
    let changed = false;

    for (const [k, v] of Object.entries(patch)) {
      const normV = (v === undefined) ? null : v;
      const normS = (snap[k] === undefined) ? null : snap[k];
      if (normV !== normS) {
        effective[k] = v;
        changed = true;
      }
    }
    if (!changed) return { ok: true, skipped: true };

    // Row-level status UI
    setRowStatus(gameId, 'Saving…');

    const { error } = await supabase
      .from('all_games')
      .update(effective)
      .eq('GameId', gameId);

    if (error) {
      setRowStatus(gameId, `Error: ${error.message}`, true);
      return { ok: false, error };
    }

    // Merge into snapshot only the fields we changed successfully
    original[gameId] = { ...original[gameId], ...effective };
    setRowStatus(gameId, 'Saved.');
    return { ok: true };
  }

  function setRowStatus(gameId, text, isErr=false){
    const el = document.querySelector(`[data-row-status="${gameId}"]`);
    if (!el) return;
    el.textContent = text;
    el.className = 'text-xs ' + (isErr ? 'text-red-300' : 'text-gray-400');
    // fade “Saved.” after a moment
    if (!isErr && text === 'Saved.') {
      setTimeout(() => {
        if (el.textContent === 'Saved.') el.textContent = '';
      }, 1200);
    }
  }

  function renderTable(){
    tbody.innerHTML = '';
    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-gray-300">No games found for this week.</td></tr>`;
      return;
    }

    for(const g of rows){
      const tr = document.createElement('tr');
      tr.className = 'border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]';

      // Game
      const tdGame = document.createElement('td');
      tdGame.className = 'px-4 py-2 font-medium text-[var(--cfp-ivory)]';
      tdGame.textContent = `${g.Away} @ ${g.Home}`;
      tr.appendChild(tdGame);

      // Start
      const tdStart = document.createElement('td');
      tdStart.className = 'px-3 py-2 text-center';
      tdStart.textContent = niceTime(g['Start (CT)']);
      tr.appendChild(tdStart);

      // Line (editable -> per-row UPDATE on change)
      const tdLine = document.createElement('td');
      tdLine.className = 'px-3 py-2 text-center';
      tdLine.innerHTML = `<input type="number" step="0.5" class="w-24 text-center rounded-none" value="${g.line ?? ''}" />`;
      const lineInput = tdLine.querySelector('input');
      lineInput.addEventListener('change', async (e) => {
        const v = e.target.value;
        const newVal = (v === '' ? null : Number(v));
        await updateRow(g.GameId, { line: newVal });
      });
      tr.appendChild(tdLine);

      // Picked (checkbox -> per-row UPDATE on change)
      const tdPicked = document.createElement('td');
      tdPicked.className = 'px-3 py-2 text-center';
      tdPicked.innerHTML = `<input type="checkbox" class="accent-[var(--cfp-gold)]" ${g.picked ? 'checked' : ''}/>`;
      const cb = tdPicked.querySelector('input');
      cb.addEventListener('change', async (e) => {
        await updateRow(g.GameId, { picked: !!e.target.checked });
      });
      tr.appendChild(tdPicked);

      // Week (read-only)
      const tdWeek = document.createElement('td');
      tdWeek.className = 'px-3 py-2 text-center text-gray-300';
      tdWeek.textContent = g.week ?? '';
      tr.appendChild(tdWeek);

      // Per-row status cell
      const tdStatus = document.createElement('td');
      tdStatus.className = 'px-3 py-2 text-right';
      tdStatus.innerHTML = `<span data-row-status="${g.GameId}" class="text-xs text-gray-400"></span>`;
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);
    }
  }

  // ---- run ----
  (async () => {
    const ok = await gatekeep();
    if(!ok) return;

    const loaded = await loadWeeks();
    if (!loaded) return;

    await loadWeek();
    weekSel.onchange = loadWeek;

    // The old “Save Changes” button is disabled since we auto-save per row
    saveBtn.disabled = true;
    saveBtn.title = 'Changes save automatically';
  })();
</script>