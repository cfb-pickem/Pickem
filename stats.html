<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em — Stats (CFP Theme)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Use relative paths for GitHub Pages -->
  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root{
      --cfp-black:#0B0B0B;
      --cfp-charcoal:#111213;
      --cfp-gold:#C99210;
      --cfp-gold-2:#E3B23C;
      --cfp-ivory:#F7F4ED;
      --cfp-gray:#1F2022;
      --ring: 0 0 0 2px var(--cfp-gold) inset, 0 0 0 2px var(--cfp-gold);
    }

    body{
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(201,146,16,.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.03) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      background-size: 100% 100%, 24px 24px, auto;
      color: #e7e7e7;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      min-height: 100vh;
    }

    .gold-shadow{box-shadow: 0 0 0 1px rgba(233, 185, 73, .35), 0 0 24px rgba(233, 185, 73, .08) inset}
    .cfp-card{background:linear-gradient(180deg, var(--cfp-black), var(--cfp-gray));border:1px solid rgba(231,231,231,.10)}
    .stripe{background: repeating-linear-gradient(90deg, transparent 0 40px, rgba(233,185,73,.12) 40px 48px)}
    .trophy-oval{width:18px;height:36px;border:2px solid var(--cfp-gold);border-radius:999px;position:relative}
    .trophy-oval::before{content:"";position:absolute;left:50%;top:4px;bottom:4px;width:2px;background:linear-gradient(var(--cfp-gold),var(--cfp-gold-2));transform:translateX(-50%)}

    .table th,.table td{border-color:rgba(231,231,231,.08)}
    .table tbody tr:hover{background:rgba(233,185,73,.06)}
  </style>
</head>

<body data-page="stats">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Shared nav mounts here -->
    <div id="site-nav"></div>

    <header class="cfp-card rounded-none stripe gold-shadow mb-5">
      <div class="flex items-center justify-between px-4 py-4 md:px-6 md:py-5">
        <div class="flex items-center gap-3 md:gap-4">
          <span class="trophy-oval"></span>
          <div>
            <p class="text-[11px] tracking-[.25em] text-gray-300 uppercase">College Football Pick'em</p>
            <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">Season Stats</h1>
          </div>
        </div>
        <div class="text-xs text-gray-300" id="status">Loading…</div>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Perfect Weeks -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Perfect Week Club</h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Week</th>
              </tr>
            </thead>
            <tbody id="perfect-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Zero-Week Club -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Zero-Week Club</h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Zero Weeks</th>
              </tr>
            </thead>
            <tbody id="zero-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Win % in last 8 decided picks -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Win % in Last 8 Picks</h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Record</th>
                <th class="px-4 py-2 text-left font-semibold">Win %</th>
              </tr>
            </thead>
            <tbody id="form-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    // ✅ Relative imports so it works whether your Pages site is at the root or a subfolder
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    // Init shared navigation
    initNav();

    // ------- Stats logic -------
    const statusEl    = document.getElementById('status');
    const perfectBody = document.getElementById('perfect-body');
    const zeroBody    = document.getElementById('zero-body');
    const formBody    = document.getElementById('form-body');

    function stripAccents(s){ try { return s.normalize('NFD').replace(/\p{Diacritic}/gu, ''); } catch { return s; } }
    function norm(v){
      if(!v) return '';
      return stripAccents(String(v))
        .toLowerCase()
        .replace(/&/g,' and ')
        .replace(/\./g,'')
        .replace(/[^a-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    const stToState = s => s.replace(/\bst\b/g,'state');
    const stateToSt = s => s.replace(/\bstate\b/g,'st');
    function sameTeam(a,b){ const na=norm(a), nb=norm(b); return na===nb || stToState(na)===stToState(nb) || stateToSt(na)===stateToSt(nb); }

    function setStatus(msg, isErr=false){
      statusEl.className = 'text-xs ' + (isErr ? 'text-red-300' : 'text-gray-300');
      statusEl.textContent = msg;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    async function main(){
      setStatus('Loading data…');

      const { data: allGames, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, week, winner, picked')
        .eq('picked', true);

      if(gErr){ console.error(gErr); return setStatus('Error loading games', true); }

      const gameMeta = Object.create(null);
      const gameIds  = [];
      for(const g of (allGames||[])){
        if(g && g.GameId != null){
          gameMeta[g.GameId] = { week: g.week ?? null, winner: g.winner ?? null };
          gameIds.push(g.GameId);
        }
      }
      if(!gameIds.length){ return setStatus('No picked games found', true); }

      const { data: picks, error: pErr } = await supabase
        .from('picks')
        .select('team_id, game_id, pick')
        .in('game_id', gameIds);
      if(pErr){ console.error(pErr); return setStatus('Error loading picks', true); }

      const { data: teams, error: tErr } = await supabase
        .from('teams')
        .select('team_id, team_name');
      if(tErr){ console.error(tErr); return setStatus('Error loading teams', true); }

      const teamName = new Map((teams||[]).map(t => [t.team_id, t.team_name]));

      const byTeamWeek = new Map();
      const byTeamDecided = new Map();

      for(const p of (picks||[])){
        const meta = gameMeta[p.game_id];
        if(!meta) continue;
        const week = meta.week;
        const winner = meta.winner;

        const twKey = `${p.team_id}|${week}`;
        if(!byTeamWeek.has(twKey)) byTeamWeek.set(twKey, []);
        byTeamWeek.get(twKey).push({ ...p, week, winner });

        if(winner != null){
          if(!byTeamDecided.has(p.team_id)) byTeamDecided.set(p.team_id, []);
          byTeamDecided.get(p.team_id).push({ ...p, week, winner });
        }
      }

      const perfectRows = [];
      const zeroTally = new Map();

      for(const [key, rows] of byTeamWeek.entries()){
        const decided = rows.filter(r => r.winner != null);
        if(decided.length === 0) continue;

        let correct = 0;
        for(const r of decided){
          if(sameTeam(r.pick, r.winner)) correct++;
        }

        const [teamIdStr, wkStr] = key.split('|');
        const team_id = Number(teamIdStr);
        const week = Number(wkStr);

        if(correct === decided.length){
          perfectRows.push({ team: teamName.get(team_id) || `Team ${team_id}`, week });
        }
        if(correct === 0){
          zeroTally.set(team_id, (zeroTally.get(team_id)||0) + 1);
        }
      }

      perfectRows.sort((a,b)=> a.week - b.week || a.team.localeCompare(b.team));
      perfectBody.innerHTML = perfectRows.map(r =>
        `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
           <td class="px-4 py-2">${escapeHtml(r.team)}</td>
           <td class="px-4 py-2">${r.week}</td>
         </tr>`).join('');

      const zeroRows = [...zeroTally.entries()]
        .map(([team_id, cnt]) => ({ team: teamName.get(team_id) || `Team ${team_id}`, cnt }))
        .sort((a,b)=> b.cnt - a.cnt || a.team.localeCompare(b.team));

      zeroBody.innerHTML = zeroRows.map(r =>
        `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
           <td class="px-4 py-2">${escapeHtml(r.team)}</td>
           <td class="px-4 py-2">${r.cnt}</td>
         </tr>`).join('');

      const formRows = [];
      for(const [team_id, arr] of byTeamDecided.entries()){
        const decidedSorted = [...arr].sort((a,b)=> (a.week - b.week) || (a.game_id - b.game_id));
        const last8 = decidedSorted.slice(-8);
        if(last8.length === 0) continue;

        let wins = 0;
        for(const r of last8){
          if(sameTeam(r.pick, r.winner)) wins++;
        }
        const pct = (wins / last8.length) * 100;
        formRows.push({
          team: teamName.get(team_id) || `Team ${team_id}`,
          record: `${wins}-${last8.length - wins}`,
          pct: pct
        });
      }

      formRows.sort((a,b)=> b.pct - a.pct || a.team.localeCompare(b.team));
      formBody.innerHTML = formRows.map(r =>
        `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
           <td class="px-4 py-2">${escapeHtml(r.team)}</td>
           <td class="px-4 py-2">${r.record}</td>
           <td class="px-4 py-2">${r.pct.toFixed(1)}%</td>
         </tr>`).join('');

      setStatus('Loaded');
    }

    main();
  </script>
</body>
</html>