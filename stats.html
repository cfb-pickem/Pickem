<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em — Season Stats (Favorites & Form)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root{
      --cfp-black:#0B0B0B;
      --cfp-charcoal:#111213;
      --cfp-gold:#C99210;
      --cfp-gold-2:#E3B23C;
      --cfp-ivory:#F7F4ED;
      --cfp-gray:#1F2022;
      --ring: 0 0 0 2px var(--cfp-gold) inset, 0 0 0 2px var(--cfp-gold);
    }

    body{
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(201,146,16,.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.03) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      background-size: 100% 100%, 24px 24px, auto;
      color: #e7e7e7;
      font-family: 'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      min-height: 100vh;
    }

    .gold-shadow{box-shadow: 0 0 0 1px rgba(233,185,73,.35), 0 0 24px rgba(233,185,73,.08) inset}
    .cfp-card{background:linear-gradient(180deg, var(--cfp-black), var(--cfp-gray));border:1px solid rgba(231,231,231,.10)}
    .stripe{background: repeating-linear-gradient(90deg, transparent 0 40px, rgba(233,185,73,.12) 40px 48px)}
    .trophy-oval{width:18px;height:36px;border:2px solid var(--cfp-gold);border-radius:999px;position:relative}
    .trophy-oval::before{content:"";position:absolute;left:50%;top:4px;bottom:4px;width:2px;background:linear-gradient(var(--cfp-gold),var(--cfp-gold-2));transform:translateX(-50%)}

    .table th,.table td{border-color:rgba(231,231,231,.08)}
    .table tbody tr:hover{background:rgba(233,185,73,.06)}

    .ribbon{background:linear-gradient(180deg,#2b2c2e,#1b1c1d);border:1px solid rgba(231,231,231,.10)}
    .chip{background:var(--cfp-gold); color:#0b0b0b; font-weight:700; letter-spacing:.01em}
    .cfp-select{background:var(--cfp-black);color:#f1f1f1;border:1px solid rgba(231,231,231,.12)}
    .cfp-select:focus{outline:none;box-shadow:var(--ring)}
  </style>
</head>

<body data-page="stats">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div id="site-nav"></div>

    <header class="cfp-card rounded-none stripe gold-shadow mb-4">
      <div class="flex items-center justify-between px-4 py-4 md:px-6 md:py-5">
        <div class="flex items-center gap-3 md:gap-4">
          <span class="trophy-oval"></span>
          <div>
            <p class="text-[11px] tracking-[.25em] text-gray-300 uppercase">College Football Pick'em</p>
            <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">Season Stats</h1>
          </div>
        </div>

        <!-- Season filter -->
        <div class="flex items-center gap-3 text-sm">
          <label class="text-gray-300">Season</label>
          <select id="season-select" class="cfp-select rounded-none px-3 py-2 text-sm min-w-[120px]"></select>
        </div>
      </div>
      <div class="px-4 md:px-6 pb-3 text-xs text-gray-300">
        <span id="status">Loading…</span>
      </div>
    </header>

    <!-- RIBBONS ROW -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Perfect Week Club -->
      <div class="ribbon gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Perfect Week Club</h2>
        </div>
        <div id="perfect-ribbon" class="flex items-center gap-2 overflow-x-auto px-4 md:px-6 py-3"></div>
      </div>

      <!-- Winless Week Club -->
      <div class="ribbon gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Winless Week Club</h2>
        </div>
        <div id="zero-ribbon" class="flex flex-wrap items-center gap-2 px-4 md:px-6 py-3"></div>
      </div>
    </section>

    <!-- SEASON-WIDE TABLES: Win % + Top Dawg -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- LEFT: Total Season Win % -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">
            Total Season Win %
          </h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Record</th>
                <th class="px-4 py-2 text-left font-semibold">Win %</th>
              </tr>
            </thead>
            <tbody id="season-body"></tbody>
          </table>
        </div>
      </div>

      <!-- RIGHT: Top Dawg – Underdog Outright Wins -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">
            Top Dawg – Underdog Outright Wins
          </h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Dog Wins</th>
              </tr>
            </thead>
            <tbody id="dog-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- LOWER CARDS -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Win % in Last 8 Picks -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Win % in Last 8 Picks</h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Record</th>
                <th class="px-4 py-2 text-left font-semibold">Win %</th>
              </tr>
            </thead>
            <tbody id="form-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Favorite Pick % -->
      <div class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-3 border-b border-[rgba(231,231,231,.08)] flex items-center gap-3">
          <span class="trophy-oval"></span>
          <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl font-semibold text-[var(--cfp-ivory)]">Favorite Pick %</h2>
        </div>
        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead>
              <tr class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
                <th class="px-4 py-2 text-left font-semibold">Team</th>
                <th class="px-4 py-2 text-left font-semibold">Favorite %</th>
              </tr>
            </thead>
            <tbody id="favorite-body"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    const statusEl      = document.getElementById('status');
    const seasonSel     = document.getElementById('season-select');
    const perfectRibbon = document.getElementById('perfect-ribbon');
    const zeroRibbon    = document.getElementById('zero-ribbon');
    const favoriteBody  = document.getElementById('favorite-body');
    const formBody      = document.getElementById('form-body');
    const seasonBody    = document.getElementById('season-body');
    const dogBody       = document.getElementById('dog-body');

    function stripAccents(s){ try { return s.normalize('NFD').replace(/\p{Diacritic}/gu, ''); } catch { return s; } }
    function norm(v){
      if(!v) return '';
      return stripAccents(String(v))
        .toLowerCase()
        .replace(/&/g,' and ')
        .replace(/\./g,'')
        .replace(/[^a-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    const stToState = s => s.replace(/\bst\b/g,'state');
    const stateToSt = s => s.replace(/\bstate\b/g,'st');
    function sameTeam(a,b){ const na=norm(a), nb=norm(b); return na===nb || stToState(na)===stToState(nb) || stateToSt(na)===stateToSt(nb); }

    function setStatus(msg, isErr=false){
      statusEl.className = 'text-xs ' + (isErr ? 'text-red-300' : 'text-gray-300');
      statusEl.textContent = msg;
    }
    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
    // Parse "Start (CT)" which is stored as a timestamp in CT; we read it as local Date.
    function parseCT(ts){
      if(!ts) return null;
      const d = new Date(String(ts).replace(' ', 'T'));
      return isNaN(d.getTime()) ? null : d;
    }

    async function loadSeasons(){
      setStatus('Loading seasons…');
      const { data, error } = await supabase
        .from('all_games')
        .select('cfb_season')
        .not('cfb_season', 'is', null);
      if(error){ setStatus('Error loading seasons', true); return false; }
      const seasons = [...new Set((data||[]).map(r => Number(r.cfb_season)).filter(n => Number.isFinite(n)))]
        .sort((a,b)=>a-b);
      if(!seasons.length){ setStatus('No seasons found', true); return false; }
      seasonSel.innerHTML = seasons.map(s => `<option value="${s}">${s}</option>`).join('');
      seasonSel.value = String(seasons[seasons.length-1]); // latest
      return true;
    }

    async function main(){
      setStatus('Loading data…');

      const season = Number(seasonSel.value);
      if(!Number.isFinite(season)){ setStatus('Select a season', true); return; }

      // Pull only picked games for the chosen season
      const { data: allGames, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, week, winner, picked, Away, Home, line, "Start (CT)", cfb_season')
        .eq('picked', true)
        .eq('cfb_season', season);

      if(gErr){ console.error(gErr); return setStatus('Error loading games', true); }

      // --- Build per-game metadata + week aggregates ---
      const gameMeta = Object.create(null);
      const gameIds  = [];
      const pickedByWeek = new Map(); // week -> { totalPicked, withWinner, earliestStart }

      for(const g of (allGames||[])){
        if(!g || g.GameId == null) continue;

        const start = parseCT(g['Start (CT)']);
        const w = g.week ?? null;

        gameMeta[g.GameId] = {
          week: w,
          winner: g.winner ?? null,
          away: g.Away || null,
          home: g.Home || null,
          line: (g.line==null? null : Number(g.line)),
          start: start
        };
        gameIds.push(g.GameId);

        if(!pickedByWeek.has(w)) pickedByWeek.set(w, { totalPicked:0, withWinner:0, earliestStart:null });
        const agg = pickedByWeek.get(w);
        agg.totalPicked += 1;
        if(g.winner != null) agg.withWinner += 1;
        if(start){
          if(!agg.earliestStart || start < agg.earliestStart) agg.earliestStart = start;
        }
      }

      if(!gameIds.length){
        perfectRibbon.innerHTML = '<span class="text-sm text-gray-300">No picked games found for this season.</span>';
        zeroRibbon.innerHTML    = '<span class="text-sm text-gray-300">No picked games found for this season.</span>';
        favoriteBody.innerHTML  = '';
        formBody.innerHTML      = '';
        seasonBody.innerHTML    = '<tr><td class="px-4 py-2 text-gray-300" colspan="3">No decided picks yet.</td></tr>';
        dogBody.innerHTML       = '<tr><td class="px-4 py-2 text-gray-300" colspan="2">No underdog wins yet.</td></tr>';
        return setStatus('Loaded');
      }

      // Week sets
      const now = new Date();
      const completeWeeks = new Set(
        [...pickedByWeek.entries()]
          .filter(([_, v]) => v.totalPicked > 0 && v.totalPicked === v.withWinner)
          .map(([w]) => w)
      );
      const startedWeeks = new Set(
        [...pickedByWeek.entries()]
          .filter(([_, v]) => v.earliestStart && v.earliestStart <= now)
          .map(([w]) => w)
      );

      const [{ data: picks, error: pErr }, { data: teams, error: tErr }] = await Promise.all([
        supabase.from('picks').select('team_id, game_id, pick').in('game_id', gameIds),
        supabase.from('teams').select('team_id, team_name')
      ]);
      if(pErr){ console.error(pErr); return setStatus('Error loading picks', true); }
      if(tErr){ console.error(tErr); return setStatus('Error loading teams', true); }

      const teamName = new Map((teams||[]).map(t => [t.team_id, t.team_name]));

      // ------- Build per-week and decided maps for THIS season -------
      const byTeamWeek = new Map();    // "teamId|week" -> rows[]
      const byTeamDecided = new Map(); // teamId -> decided rows[]

      for(const p of (picks||[])){
        const meta = gameMeta[p.game_id];
        if(!meta) continue;
        const week = meta.week; const winner = meta.winner;

        const twKey = `${p.team_id}|${week}`;
        if(!byTeamWeek.has(twKey)) byTeamWeek.set(twKey, []);
        byTeamWeek.get(twKey).push({ ...p, week, winner });

        if(winner != null){
          if(!byTeamDecided.has(p.team_id)) byTeamDecided.set(p.team_id, []);
          byTeamDecided.get(p.team_id).push({ ...p, week, winner });
        }
      }

      // ------- Perfect Week tally (completed weeks only) -------
      const perfectTally = new Map(); // team_id -> count
      for(const [key, rows] of byTeamWeek.entries()){
        const week = rows.length ? rows[0].week : null;
        if(!completeWeeks.has(week)) continue; // only finished weeks

        let correct = 0;
        for(const r of rows){ if(sameTeam(r.pick, r.winner)) correct++; }
        if(rows.length > 0 && correct === rows.length){
          const teamId = Number(key.split('|')[0]);
          perfectTally.set(teamId, (perfectTally.get(teamId) || 0) + 1);
        }
      }
      if(perfectTally.size){
        const chips = [...perfectTally.entries()]
          .sort((a,b)=> b[1]-a[1] || (teamName.get(a[0])||'').localeCompare(teamName.get(b[0])||''))
          .map(([id,cnt]) => {
            const label = `${escapeHtml(teamName.get(id) || `Team ${id}`)}${cnt>1 ? ` (${cnt})` : ''}`;
            return `<span class="chip px-3 py-1 rounded-md whitespace-nowrap">${label}</span>`;
          }).join('');
        perfectRibbon.innerHTML = chips;
      } else {
        perfectRibbon.innerHTML = '<span class="text-sm text-gray-300">No perfect weeks yet (completed weeks only).</span>';
      }

      // ------- Winless Week tally (completed weeks only) -------
      const zeroTally = new Map(); // team_id -> count
      for(const [key, rows] of byTeamWeek.entries()){
        const week = rows.length ? rows[0].week : null;
        if(!completeWeeks.has(week)) continue;

        let correct = 0; for(const r of rows){ if(sameTeam(r.pick, r.winner)) correct++; }
        if(rows.length > 0 && correct === 0){
          const teamId = Number(key.split('|')[0]);
          zeroTally.set(teamId, (zeroTally.get(teamId) || 0) + 1);
        }
      }
      if(zeroTally.size){
        const chips = [...zeroTally.entries()]
          .sort((a,b)=> b[1]-a[1] || (teamName.get(a[0])||'').localeCompare(teamName.get(b[0])||''))
          .map(([id,cnt]) => {
            const label = `${escapeHtml(teamName.get(id) || `Team ${id}`)}${cnt>1 ? ` (${cnt})` : ''}`;
            return `<span class="chip px-3 py-1 rounded-md whitespace-nowrap">${label}</span>`;
          }).join('');
        zeroRibbon.innerHTML = chips;
      } else {
        zeroRibbon.innerHTML = '<span class="text-sm text-gray-300">No winless weeks yet (completed weeks only).</span>';
      }

      // ------- Total Season Win % (all decided picks this season) -------
      const seasonStats = new Map(); // team_id -> { wins, total }

      for(const [team_id, arr] of byTeamDecided.entries()){
        let wins = 0;
        for(const r of arr){
          if(sameTeam(r.pick, r.winner)) wins++;
        }
        seasonStats.set(team_id, { wins, total: arr.length });
      }

      const seasonRows = [...seasonStats.entries()].map(([team_id, {wins, total}])=>{
        const pct = total ? wins / total : 0;
        const pctStr = pct.toFixed(3).slice(1); // .459 format
        return {
          team: teamName.get(team_id) || `Team ${team_id}`,
          record: `${wins}-${total - wins}`,
          pct,
          pctStr
        };
      }).sort((a,b)=> b.pct - a.pct || a.team.localeCompare(b.team));

      seasonBody.innerHTML =
        seasonRows.length
          ? seasonRows.map(r =>
              `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
                <td class="px-4 py-2">${escapeHtml(r.team)}</td>
                <td class="px-4 py-2">${r.record}</td>
                <td class="px-4 py-2">${r.pctStr}</td>
              </tr>`
            ).join('')
          : `<tr><td class="px-4 py-2 text-gray-300" colspan="3">No decided picks yet.</td></tr>`;

      // ------- Favorite Pick % (exclude weeks that haven't started) -------
      const favStats = new Map(); // team_id -> { fav: n, opp: d }
      function favoriteTeamFor(game){
        const line = game.line;
        if(line == null || isNaN(line) || line === 0) return null; // no favorite
        // Convention: line is from home perspective; negative => home favorite; positive => away favorite
        return line < 0 ? game.home : game.away;
      }
      function underdogTeamFor(game){
        const line = game.line;
        if(line == null || isNaN(line) || line === 0) return null;
        return line < 0 ? game.away : game.home;
      }

      for(const p of (picks||[])){
        const g = gameMeta[p.game_id];
        if(!g || !p.pick) continue;

        // only count this pick if the week has started
        if(!startedWeeks.has(g.week)) continue;

        const favTeam = favoriteTeamFor(g);
        if(!favTeam) continue;

        const tId = p.team_id;
        if(!favStats.has(tId)) favStats.set(tId, { fav:0, opp:0 });
        const entry = favStats.get(tId);
        entry.opp++;
        if(sameTeam(p.pick, favTeam)) entry.fav++;
      }
      const favRows = [...favStats.entries()].map(([team_id, {fav, opp}])=>({
        team: teamName.get(team_id) || `Team ${team_id}`,
        pct: opp ? (fav/opp*100) : 0
      })).sort((a,b)=> b.pct - a.pct || a.team.localeCompare(b.team));
      favoriteBody.innerHTML =
        favRows.length
          ? favRows.map(r =>
              `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
                <td class="px-4 py-2">${escapeHtml(r.team)}</td>
                <td class="px-4 py-2">${r.pct.toFixed(1)}%</td>
              </tr>`
            ).join('')
          : `<tr><td class="px-4 py-2 text-gray-300" colspan="2">No favorite picks yet.</td></tr>`;

      // ------- Form: last 8 decided picks (season-only) -------
      const formRows = [];
      for(const [team_id, arr] of byTeamDecided.entries()){
        const decidedSorted = [...arr].sort((a,b)=> (a.week - b.week) || (a.game_id - b.game_id));
        const last8 = decidedSorted.slice(-8);
        if(!last8.length) continue;
        let wins = 0; for(const r of last8){ if(sameTeam(r.pick, r.winner)) wins++; }
        const pct = (wins / last8.length) * 100;
        formRows.push({ team: teamName.get(team_id) || `Team ${team_id}`, record: `${wins}-${last8.length - wins}`, pct });
      }
      formRows.sort((a,b)=> b.pct - a.pct || a.team.localeCompare(b.team));
      formBody.innerHTML =
        formRows.length
          ? formRows.map(r =>
              `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
                <td class="px-4 py-2">${escapeHtml(r.team)}</td>
                <td class="px-4 py-2">${r.record}</td>
                <td class="px-4 py-2">${r.pct.toFixed(1)}%</td>
              </tr>`
            ).join('')
          : `<tr><td class="px-4 py-2 text-gray-300" colspan="3">No decided picks yet.</td></tr>`;

      // ------- Top Dawg – Underdog Outright Wins -------
      const dogWins = new Map();  // team_id -> count

      for (const p of (picks || [])) {
        const g = gameMeta[p.game_id];
        if (!g || !p.pick || !g.winner) continue;

        const dog = underdogTeamFor(g);
        if (!dog) continue;

        // If they picked the underdog AND the underdog won outright
        if (sameTeam(p.pick, dog) && sameTeam(g.winner, dog)) {
          const tId = p.team_id;
          dogWins.set(tId, (dogWins.get(tId) || 0) + 1);
        }
      }

      const dogRows = [...dogWins.entries()]
        .map(([team_id, wins]) => ({
          team: teamName.get(team_id) || `Team ${team_id}`,
          wins
        }))
        .sort((a,b)=> b.wins - a.wins || a.team.localeCompare(b.team));

      dogBody.innerHTML =
        dogRows.length
          ? dogRows.map(r =>
              `<tr class="border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]">
                <td class="px-4 py-2">${escapeHtml(r.team)}</td>
                <td class="px-4 py-2">${r.wins}</td>
              </tr>`
            ).join('')
          : `<tr><td class="px-4 py-2 text-gray-300" colspan="2">No underdog wins yet.</td></tr>`;

      setStatus(`Loaded • Season ${season}`);
    }

    async function startup(){
      await initNav();
      const ok = await loadSeasons();
      if(!ok) return;

      await main();
      seasonSel.onchange = main;
    }

    startup();
  </script>
</body>
</html>