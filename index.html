<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em ‚Äî Thanksgiving Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root{
      /* Harvest / Thanksgiving palette */
      --cfp-black:#1a120b;        /* roasted coffee brown */
      --cfp-charcoal:#120c07;     /* deep roasted turkey skin */
      --cfp-gold:#f2a71b;         /* pumpkin pie filling */
      --cfp-gold-2:#f7c35c;       /* cornbread / cornbread crust */
      --cfp-ivory:#fff7e6;        /* mashed potatoes / parchment */
      --cfp-gray:#3a2517;         /* gravy brown */
      --ring: 0 0 0 2px var(--cfp-gold) inset, 0 0 0 2px var(--cfp-gold);
    }

    body{
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(242,167,27,.25), transparent 60%),
        radial-gradient(900px 600px at 0% 0%, rgba(178,93,29,.22), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(139,69,19,.25), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.05) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      background-size:100% 100%,100% 100%,100% 100%,24px 24px,auto;
      color:#f9f5ee;
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
    }

    /* Subtle falling leaves for over-the-top vibe */
    .leaf{
      position:fixed;
      top:-40px;
      font-size:20px;
      opacity:.35;
      filter:drop-shadow(0 0 6px rgba(0,0,0,.5));
      pointer-events:none;
      animation:fall 16s linear infinite;
    }
    .leaf:nth-child(2){left:10%;animation-duration:19s;font-size:22px;animation-delay:2s;}
    .leaf:nth-child(3){left:25%;animation-duration:15s;font-size:18px;animation-delay:5s;}
    .leaf:nth-child(4){left:55%;animation-duration:21s;font-size:24px;animation-delay:1s;}
    .leaf:nth-child(5){left:72%;animation-duration:18s;font-size:20px;animation-delay:7s;}
    .leaf:nth-child(6){left:88%;animation-duration:20s;font-size:19px;animation-delay:3s;}

    @keyframes fall{
      0%{transform:translateY(0) rotate(0deg);}
      50%{transform:translateY(60vh) rotate(140deg);}
      100%{transform:translateY(110vh) rotate(320deg);}
    }

    .network-line{
      display:inline-flex;
      align-items:center;
      font-size:10px;
      line-height:1;
      letter-spacing:.15em;
      text-transform:uppercase;
      color:#fec89a;
      margin:0;
    }
    .badge.inline-fix{display:inline-flex;align-items:center;line-height:1;padding-top:.125rem;padding-bottom:.125rem}

    .table-sticky th{position:sticky;top:0;background-color:var(--cfp-black);z-index:10}
    .gold-shadow{box-shadow:
      0 0 0 1px rgba(247,195,92,.4),
      0 0 24px rgba(247,195,92,.22) inset,
      0 18px 40px rgba(0,0,0,.55);
    }

    /* From trophy to turkey platter */
    .trophy-oval{
      width:40px;
      height:40px;
      border-radius:999px;
      position:relative;
      background:radial-gradient(circle at 30% 30%, #ffe8b3, #f2a71b 45%, #8b4513 80%);
      box-shadow:
        0 0 0 2px rgba(255,248,220,.7),
        0 0 18px rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .trophy-oval::before{
      content:"ü¶É";
      font-size:1.5rem;
      transform:translateY(1px);
    }

    .cfp-select{
      background:linear-gradient(135deg,#3b2515,#231207);
      color:#fdf3dc;
      border:1px solid rgba(255,248,220,.35);
      box-shadow:0 0 0 1px rgba(0,0,0,.65);
    }
    .cfp-select:focus{
      outline:none;
      box-shadow:var(--ring),0 0 0 1px rgba(0,0,0,.9);
    }
    .cfp-card{
      background:
        linear-gradient(180deg,rgba(255,247,230,.03),transparent 40%),
        radial-gradient(circle at 0 0,rgba(255,255,255,.08),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(255,255,255,.05),transparent 45%),
        linear-gradient(180deg,var(--cfp-black),var(--cfp-gray));
      border:1px solid rgba(255,247,230,.14);
      position:relative;
    }

    /* Thanksgiving ribbon border */
    .harvest-border{
      border-image-slice:1;
      border-style:solid;
      border-width:3px 0 0 0;
      border-image-source:repeating-linear-gradient(
        90deg,
        #f2a71b 0 16px,
        #c55a11 16px 32px,
        #8b4513 32px 48px,
        #f9dec9 48px 64px
      );
    }

    .badge{
      font-size:.72rem;
      line-height:1rem;
      display:inline-flex;
      align-items:center;
      gap:.375rem;
      padding:.125rem .55rem;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.5);
      box-shadow:0 1px 4px rgba(0,0,0,.4);
    }
    .badge-final{
      background:linear-gradient(135deg,#7b341e,#c05621);
      color:#fff7e6;
    }
    .badge-live{
      background:radial-gradient(circle at 20% 20%,#ffe6a7,#f2a71b);
      color:#3b2515;
    }
    .badge-sched{
      background:linear-gradient(135deg,#2b211b,#4a3420);
      color:#f5e6c8;
      border:1px solid rgba(245,230,200,.2);
    }

    .table th,.table td{border-color:rgba(255,247,230,.11)}
    .table tbody tr:hover{
      background:linear-gradient(90deg,rgba(242,167,27,.2),rgba(114,54,23,.35));
    }

    .pick-win{
      background:linear-gradient(135deg,rgba(128,179,71,.35),rgba(88,129,50,.45));
      color:#e3f6c7;
      box-shadow:0 0 12px rgba(89,139,43,.45) inset;
    }
    .pick-loss{
      background:linear-gradient(135deg,rgba(185,63,63,.35),rgba(142,38,38,.45));
      color:#ffd5d5;
      box-shadow:0 0 12px rgba(110,22,22,.55) inset;
    }
    .pick-empty{
      color:#cbd5f0;
      opacity:.8;
    }

    .logo{
      height:32px;
      width:32px;
      object-fit:contain;
      margin-left:auto;
      margin-right:auto;
      filter:
        drop-shadow(0 0 3px rgba(0,0,0,.7))
        sepia(.18)
        saturate(1.2);
    }

    .stripe{
      background:
        repeating-linear-gradient(45deg,
          rgba(242,167,27,.08) 0 10px,
          rgba(92,46,16,.24) 10px 20px
        );
    }
    .ring-gold{box-shadow:var(--ring)}

    .playoff-divider td{
      padding:.25rem 0;
      background:linear-gradient(90deg,rgba(242,167,27,.2),rgba(255,247,230,.05));
      border-top:2px dashed rgba(247,195,92,.9);
      color:var(--cfp-ivory);
      text-align:center;
      letter-spacing:.16em;
      font-size:.75rem;
      text-transform:uppercase;
      position:relative;
    }
    .playoff-divider td::before{
      content:"ü•ß";
      position:absolute;
      left:8px;
      top:50%;
      transform:translateY(-50%);
    }
    .playoff-divider td::after{
      content:"ü•ß";
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
    }

    th.sticky-col-1, td.sticky-col-1{
      position: sticky;
      left: 0;
      z-index: 25;
      background: linear-gradient(90deg,var(--cfp-black),#351d0f);
      box-shadow: 2px 0 0 rgba(231,231,231,.08) inset;
    }
    thead th.sticky-col-1{ z-index: 50; }

    .scroll-shadows{ position: relative; }

    @media (max-width: 640px){
      .logo{height:24px;width:24px}
      th, td { padding-top: .4rem !important; padding-bottom: .4rem !important; }
      thead th { font-size: .8rem; }
      .network-line{ font-size:9px; letter-spacing:.12em; }
      .badge { font-size: .65rem; padding: .08rem .45rem; }
      .table tbody td { font-size: .84rem; }
      thead th > :first-child{
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 130px;
        display: inline-block;
      }
    }

    nav[data-nav="root"]{position:relative;z-index:60;pointer-events:auto}

    /* Weekly submissions labels */
    .ws-label{
      font-size:.72rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#ffe8c2;
      border-bottom:1px solid rgba(231,231,231,.12);
      padding-bottom:.25rem;
      margin-bottom:.5rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .ws-label span.icon{
      font-size:1rem;
    }

    /* Highlight logged-in user's team row */
    tr[data-me="true"]{
      background:
        linear-gradient(90deg,rgba(247,195,92,.45),rgba(242,167,27,.12));
    }
    tr[data-me="true"] .sticky-col-1{
      font-weight:700;
      text-shadow:0 0 8px rgba(0,0,0,.9);
      box-shadow:2px 0 0 rgba(247,195,92,.9) inset;
      position:relative;
    }
    tr[data-me="true"] .sticky-col-1::before{
      content:"üçó";
      margin-right:.4rem;
    }
    tr[data-me="true"]:hover{
      background:
        linear-gradient(90deg, rgba(247,195,92,.65), rgba(179,94,34,.45));
    }

    /* Thanksgiving header extras */
    .thanksgiving-header{
      position:relative;
      overflow:hidden;
    }
    .thanksgiving-header::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 0 0,rgba(255,255,255,.15),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(255,255,255,.12),transparent 60%);
      opacity:.35;
      pointer-events:none;
    }
    .header-pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.18rem .6rem;
      border-radius:999px;
      background:linear-gradient(135deg,rgba(59,37,21,.9),rgba(36,20,11,.95));
      border:1px solid rgba(255,247,230,.35);
      box-shadow:0 0 14px rgba(0,0,0,.7);
      font-size:.7rem;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#ffe7bb;
    }
    .header-pill span.emoji{
      font-size:1rem;
    }

    /* Legend chips */
    .legend-chip{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.15rem .55rem;
      border-radius:999px;
      background:radial-gradient(circle at 0 0,#50301b,#24140b);
      border:1px solid rgba(255,247,230,.2);
      box-shadow:0 1px 3px rgba(0,0,0,.6);
    }
  </style>
</head>

<body data-page="leaderboard">
  <!-- Floating leaves -->
  <div aria-hidden="true">
    <div class="leaf">üçÇ</div>
    <div class="leaf">üçÅ</div>
    <div class="leaf">üçÉ</div>
    <div class="leaf">üçÇ</div>
    <div class="leaf">üçÅ</div>
    <div class="leaf">üçÉ</div>
  </div>

  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div id="site-nav"></div>

    <header class="cfp-card rounded-none stripe gold-shadow harvest-border thanksgiving-header mb-5">
      <div class="flex items-center justify-between px-4 py-4 md:px-6 md:py-5 gap-3 md:gap-6">
        <div class="flex items-center gap-3 md:gap-4">
          <span class="trophy-oval" aria-hidden="true"></span>
          <div>
            <div class="header-pill mb-1">
              <span class="emoji">ü¶É</span>
              <span>College Football Pick'em</span>
              <span class="emoji hidden sm:inline">üèà</span>
            </div>
            <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">
              Thanksgiving Leaderboard Feast
            </h1>
            <p class="text-xs text-amber-100/80 mt-1">
              Where winning picks are the main course and upsets are the spicy stuffing.
            </p>
          </div>
        </div>
        <div class="flex flex-col md:flex-row items-start md:items-center gap-2 md:gap-3 text-sm">
          <div class="flex flex-col gap-1">
            <label class="hidden md:block text-amber-100/90">Season</label>
            <div class="flex items-center gap-1 md:gap-2">
              <span class="hidden md:inline text-xs text-amber-200/80">üçÅ</span>
              <select id="season-select" class="cfp-select rounded-none px-3 py-2 text-sm min-w-[110px]"></select>
            </div>
          </div>

          <div class="flex flex-col gap-1 md:ml-2">
            <label class="hidden md:block text-amber-100/90">Week</label>
            <div class="flex items-center gap-1 md:gap-2">
              <span class="hidden md:inline text-xs text-amber-200/80">ü•ß</span>
              <select id="week-select" class="cfp-select rounded-none px-3 py-2 text-sm"></select>
            </div>
          </div>
        </div>
      </div>
      <div class="border-t border-[rgba(231,231,231,.18)] px-4 md:px-6 py-2 text-[11px] md:text-xs text-amber-50/90 flex items-center justify-between gap-3">
        <span id="status">Loading‚Ä¶</span>
        <span class="hidden sm:inline-flex items-center gap-1 text-[10px] tracking-[.16em] uppercase text-amber-100/70">
          <span>Gravy Metric:</span>
          <span class="font-semibold text-amber-300">1 point per correct pick</span>
        </span>
      </div>
    </header>

    <div class="cfp-card rounded-none gold-shadow overflow-auto scroll-shadows">
      <table class="table min-w-full text-sm" style="table-layout:auto;">
        <thead class="table-sticky">
          <tr id="thead-row" class="border-b"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Legend above Weekly Submissions -->
    <div class="mt-4 text-xs text-amber-100/90 flex flex-wrap items-center gap-3">
      <div class="legend-chip">
        <span class="badge badge-live">Live</span>
        <span>Games cooking in the oven</span>
      </div>
      <div class="legend-chip">
        <span class="badge badge-final">Final</span>
        <span>Served &amp; carved</span>
      </div>
      <div class="legend-chip">
        <span class="badge badge-sched">Scheduled</span>
        <span>Still marinating</span>
      </div>
      <span class="ml-1 md:ml-3 text-[11px] text-amber-50/70">
        ‚úÖ Win cells get a hearty sage-green glaze; ‚ùå loss cells get cranberry-red.
      </span>
    </div>

    <!-- Weekly Submissions -->
    <div id="weekly-submissions" class="cfp-card rounded-none gold-shadow mt-4 px-4 md:px-6 py-4">
      <h2 class="font-['Oswald',_sans-serif] text-2xl font-bold text-[var(--cfp-ivory)] mb-3 flex items-center gap-2">
        Weekly Submissions Buffet
        <span class="text-lg">üçΩÔ∏è</span>
      </h2>

      <p class="text-xs text-amber-100/80 mb-4">
        Think of your picks as dishes at the Thanksgiving table: the more complete your plate, the better your shot at the
        <span class="font-semibold text-amber-300">Golden Turkey Trophy</span>.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="ws-label">
            <span class="icon">ü¶É</span>
            <span>Stuffed With Picks (Complete Plates)</span>
          </div>
          <div id="ws-made" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <div class="ws-label">
            <span class="icon">ü•î</span>
            <span>Leftovers (Missing a Few Sides)</span>
          </div>
          <div id="ws-not" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page script (unchanged functionality) -->
  <script type="module">
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    // ---- DOM ----
    const seasonSelect = document.getElementById('season-select');
    const weekSelect   = document.getElementById('week-select');
    const statusEl     = document.getElementById('status');
    const theadRow     = document.getElementById('thead-row');
    const tbody        = document.getElementById('tbody');
    const wsMade       = document.getElementById('ws-made');
    const wsNot        = document.getElementById('ws-not');

    // ---- State ----
    let seasons = [];
    let currentSeason = null;

    let weeks = [];
    let currentWeek = null;

    let gameIds = [];
    let winnerMap = {};
    let lineMap   = {};
    let logoByTeam = {};
    let abbrByTeam = {};
    let winsByTeam = {}; // points = wins

    let lastTeams = [];
    let lastPickMap = {};
    let lastGames = [];

    // üîπ Currently logged-in user's team (for highlight)
    let currentTeamId = null;

    // Reveal control
    let weekStartTs = null;
    let showPicks = true;

    // Phone detection
    const phoneMQ = window.matchMedia('(max-width: 640px)');
    let isPhone = phoneMQ.matches;
    phoneMQ.addEventListener?.('change', (e) => {
      isPhone = e.matches;
      if (lastGames.length) {
        const nameMap = buildGameNameMap(lastGames);
        renderHeader(nameMap, lastGames);
      }
    });

    let liveTimer = null;
    const LIVE_INTERVAL_MS = 30000;

    const headerStatusEls = new Map(); // game_id -> { badgeEl, networkEl }

    // ---------- Performance helpers ----------
    const STORAGE_KEYS = {
      lastSeason: 'cfb_last_season_v1',
      lastWeek:   'cfb_last_week_v1',
      logos: 'cfb_logos_v1',
      logosTTL: 'cfb_logos_ttl_v1',
      abbrev: 'cfb_abbrev_v1',
      abbrevTTL: 'cfb_abbrev_ttl_v1',
    };
    const LOGOS_TTL_MS = 7 * 24 * 60 * 60 * 1000;

    function getCached(key) {
      const v = localStorage.getItem(key);
      return v ? Number(v) : null;
    }
    function setCached(key, val) {
      if (Number.isFinite(val)) localStorage.setItem(key, String(val));
    }
    function getCachedMap(key, ttlKey){
      try{
        const ttl = Number(localStorage.getItem(ttlKey) || 0);
        if (Date.now() > ttl) return null;
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    }
    function setCachedMap(key, ttlKey, obj){
      try{
        localStorage.setItem(key, JSON.stringify(obj || {}));
        localStorage.setItem(ttlKey, String(Date.now() + LOGOS_TTL_MS));
      }catch{}
    }

    // ---------- Helpers ----------
    function stripAccents(s){
      try { return s.normalize('NFD').replace(/\p{Diacritic}/gu, ''); }
      catch { return s; }
    }
    function norm(v){
      if(!v) return '';
      return stripAccents(String(v))
        .toLowerCase()
        .replace(/&/g,' and ')
        .replace(/\./g,'')
        .replace(/[^a-z0-9\s]/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    const stToState = s => s.replace(/\bst\b/g,'state');
    const stateToSt = s => s.replace(/\bstate\b/g,'st');
    function sameTeam(a,b){
      const na = norm(a), nb = norm(b);
      return na === nb || stToState(na) === stToState(nb) || stateToSt(na) === stateToSt(nb);
    }

    function status(msg,isErr=false){
      statusEl.className = 'text-sm ' + (isErr ? 'text-red-300' : 'text-amber-100/90');
      statusEl.textContent = msg;
    }
    function formatTimeLocal(ts){
      if(!ts) return '';
      try{
        const d = new Date(ts);
        return d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
      }catch{ return ''; }
    }

    // Build header display name for a game, using abbrev on phones
    function teamLabel(name){
      if (isPhone && abbrByTeam[name]) return abbrByTeam[name];
      return name;
    }
    function buildGameNameMap(games){
      const map = {};
      games.forEach(g=>{
        const ln = (typeof g.line === 'number') ? g.line : (g.line!=null? Number(g.line): null);
        const lineTxt = (ln!=null && !isNaN(ln)) ? (ln>0?` (+${ln})`:` (${ln})`) : '';
        map[g.GameId] = `${teamLabel(g.Away)} @ ${teamLabel(g.Home)}${lineTxt}`;
      });
      return map;
    }

    // ---------- Load current user's team (for highlight) ----------
    async function loadCurrentUserTeam(){
      try{
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return; // not signed in, no highlight

        const { data: myTeams, error: tErr } = await supabase
          .from('teams')
          .select('team_id, team_name')
          .eq('user_id', session.user.id)
          .order('team_name', { ascending: true });

        if (tErr) {
          console.warn('loadCurrentUserTeam error:', tErr.message);
          return;
        }
        if (myTeams && myTeams.length){
          currentTeamId = myTeams[0].team_id; // first team alphabetically
        }
      }catch(e){
        console.warn('loadCurrentUserTeam exception:', e);
      }
    }

    // ---------- App startup ----------
    async function startup() {
      await initNav();
      await loadCurrentUserTeam(); // üîπ get user team before we render

      await loadSeasons();
      const hintedSeason = getCached(STORAGE_KEYS.lastSeason);
      if (Number.isFinite(hintedSeason) && seasons.includes(hintedSeason)) {
        currentSeason = hintedSeason;
      } else {
        currentSeason = seasons[seasons.length-1]; // latest
      }
      seasonSelect.value = String(currentSeason);

      await loadWeeksForSeason(currentSeason);

      const hintedWeek = getCached(STORAGE_KEYS.lastWeek);
      if (Number.isFinite(hintedWeek) && weeks.includes(hintedWeek)) {
        currentWeek = hintedWeek;
      } else {
        currentWeek = weeks[weeks.length-1];
      }
      weekSelect.value = String(currentWeek);

      await init();
      await computeSeasonWins();
      await loadWeek(currentWeek);

      seasonSelect.onchange = async () => {
        currentSeason = Number(seasonSelect.value);
        setCached(STORAGE_KEYS.lastSeason, currentSeason);
        await loadWeeksForSeason(currentSeason);
        currentWeek = weeks[weeks.length-1];
        weekSelect.value = String(currentWeek);
        await computeSeasonWins();
        await loadWeek(currentWeek);
      };

      weekSelect.onchange = async ()=> {
        currentWeek = Number(weekSelect.value);
        setCached(STORAGE_KEYS.lastWeek, currentWeek);
        await computeSeasonWins();
        await loadWeek(currentWeek);
      };
    }
    startup();

    // ---------- Loaders ----------
    async function loadSeasons(){
      status('Loading seasons‚Ä¶');
      const { data, error } = await supabase
        .from('all_games')
        .select('cfb_season')
        .not('cfb_season', 'is', null);
      if(error){ status(error.message, true); throw error; }
      seasons = [...new Set((data||[]).map(r => Number(r.cfb_season)).filter(Number.isFinite))].sort((a,b)=>a-b);
      if(!seasons.length) { status('No seasons found.'); throw new Error('no seasons'); }
      seasonSelect.innerHTML = seasons.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    async function loadWeeksForSeason(season){
      status(`Loading weeks for ${season}‚Ä¶`);
      const { data, error } = await supabase
        .from('all_games')
        .select('week')
        .eq('cfb_season', season)
        .eq('picked', true)
        .not('week', 'is', null)
        .order('week', { ascending: true });
      if(error){ status(error.message, true); throw error; }
      weeks = [...new Set((data||[]).map(r=>r.week))].sort((a,b)=>a-b);
      if(!weeks.length){ status('No weeks for this season.', true); }
      weekSelect.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
    }

    async function init(){
      status('Loading logos & trimmings‚Ä¶');

      const logoCached = getCachedMap(STORAGE_KEYS.logos, STORAGE_KEYS.logosTTL);
      const abbrCached = getCachedMap(STORAGE_KEYS.abbrev, STORAGE_KEYS.abbrevTTL);
      if (logoCached) logoByTeam = logoCached;
      if (abbrCached) abbrByTeam = abbrCached;

      const { data: logoRows, error: lErr } = await supabase
        .from('logos')
        .select('Team, LogoURL, Abbrev');

      if(!lErr) {
        const mergedLogos = { ...(logoCached || {}) };
        const mergedAbbrs = { ...(abbrCached || {}) };
        (logoRows || []).forEach(r => {
          if (r?.Team) {
            if (r.LogoURL) mergedLogos[r.Team] = r.LogoURL;
            if (r.Abbrev)  mergedAbbrs[r.Team] = r.Abbrev;
          }
        });
        logoByTeam = mergedLogos;
        abbrByTeam = mergedAbbrs;
        setCachedMap(STORAGE_KEYS.logos,  STORAGE_KEYS.logosTTL,  logoByTeam);
        setCachedMap(STORAGE_KEYS.abbrev, STORAGE_KEYS.abbrevTTL, abbrByTeam);
      }
    }

    // ---------- Points (season-only) ----------
    async function computeSeasonWins(){
      status('Basting the season standings‚Ä¶');

      // Decided games for this season
      const { data: decidedGames, error: dgErr } = await supabase
        .from('all_games')
        .select('GameId, winner')
        .eq('cfb_season', currentSeason)
        .not('winner', 'is', null);
      if(dgErr){ status(dgErr.message, true); return; }

      const gameIdsSeason = (decidedGames || []).map(g => g.GameId);
      const winnerByGame = Object.create(null);
      (decidedGames||[]).forEach(g=>{ winnerByGame[g.GameId] = g.winner; });

      if (!gameIdsSeason.length){
        winsByTeam = Object.create(null);
        return;
      }

      const { data: allPicks, error: pErr } = await supabase
        .from('picks')
        .select('team_id, game_id, pick')
        .in('game_id', gameIdsSeason);
      if(pErr){ status(pErr.message, true); return; }

      winsByTeam = Object.create(null);
      (allPicks||[]).forEach(p=>{
        const winner = winnerByGame[p.game_id];
        if(!winner) return;
        if(sameTeam(p.pick, winner)){
          winsByTeam[p.team_id] = (winsByTeam[p.team_id] || 0) + 1;
        }
      });
    }

    // ---------- Load a week (season-scoped) ----------
    async function loadWeek(week){
      status(`Loading S${currentSeason} ‚Ä¢ W${week}‚Ä¶`);
      stopLiveTicker();
      headerStatusEls.clear();

      const { data: gamesRaw, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, AwayPts, HomePts, line, winner, Status, Period, Clock, "Start (CT)", Network, picked, week, espn_url, cfb_season')
        .eq('cfb_season', currentSeason)
        .eq('picked', true)
        .eq('week', week);
      if(gErr) return status(gErr.message, true);

      const games = (gamesRaw || []).slice().sort((a, b) => {
        const ta = a?.["Start (CT)"] ? new Date(a["Start (CT)"]).getTime() : Infinity;
        const tb = b?.["Start (CT)"] ? new Date(b["Start (CT)"]).getTime() : Infinity;
        return ta - tb;
      });
      lastGames = games;

      // Earliest kickoff timestamp
      weekStartTs = null;
      for (const g of games) {
        const ts = g?.["Start (CT)"] ? new Date(g["Start (CT)"]).getTime() : null;
        if (Number.isFinite(ts)) {
          weekStartTs = (weekStartTs==null) ? ts : Math.min(weekStartTs, ts);
        }
      }
      showPicks = (weekStartTs == null) ? true : (Date.now() >= weekStartTs);

      winnerMap = {}; lineMap = {};
      gameIds = games.map(g=>g.GameId);

      games.forEach(g=>{
        winnerMap[g.GameId] = g.winner ?? null;
        lineMap[g.GameId]   = (typeof g.line === 'number') ? g.line : (g.line!=null? Number(g.line): null);
      });

      const { data: teamRows, error: tErr } = await supabase
        .from('teams')
        .select('team_id, team_name')
        .order('team_name', { ascending: true });
      if(tErr) return status(tErr.message, true);

      const { data: pickRows, error: pErr } = await supabase
        .from('picks')
        .select('team_id, game_id, pick')
        .in('game_id', gameIds);
      if(pErr) return status(pErr.message, true);

      const pickMap = buildPickMap(pickRows);

      const teamsSorted = [...(teamRows || [])].sort((a,b)=>{
        const pa = winsByTeam[a.team_id] || 0;
        const pb = winsByTeam[b.team_id] || 0;
        if(pb !== pa) return pb - pa;
        return a.team_name.localeCompare(b.team_name);
      });

      lastTeams = teamsSorted;
      lastPickMap = pickMap;

      const gameNameMap = buildGameNameMap(games);
      renderHeader(gameNameMap, games);
      renderTable(teamsSorted, pickMap, winnerMap, showPicks);
      renderWeeklySubmissions(teamsSorted, pickMap);

      startLiveTicker();
      if (!showPicks && weekStartTs) {
        status(`Picks hidden until kickoff at ${formatTimeLocal(weekStartTs)} CT ‚Ä¢ Season ${currentSeason} ‚Ä¢ Week ${week}`);
      } else {
        status(`Season ${currentSeason} ‚Ä¢ Week ${week}`);
      }
    }

    function buildPickMap(rows){
      const map = {};
      (rows||[]).forEach(r=>{
        if(!map[r.team_id]) map[r.team_id] = {};
        map[r.team_id][r.game_id] = r.pick;
      });
      return map;
    }

    function getLogoForPickExact(pick){
      if(!pick) return null;
      return logoByTeam[pick] || null;
    }

    function renderHeader(gameNameMap, gameRows){
      theadRow.innerHTML = '';

      // TEAM
      const thTeam = document.createElement('th');
      thTeam.className = 'text-left pl-4 pr-2 py-3 font-semibold text-[var(--cfp-ivory)] bg-[var(--cfp-black)] font-[Oswald] tracking-wide sticky-col-1';
      thTeam.textContent = 'Table Guest';
      theadRow.appendChild(thTeam);

      // POINTS
      const thPts = document.createElement('th');
      thPts.className = 'pl-2 pr-3 py-3 text-center font-semibold text-[var(--cfp-ivory)] bg-[var(--cfp-black)] font-[Oswald] tracking-wide';
      thPts.textContent = 'Turkey Points';
      theadRow.appendChild(thPts);

      gameIds.forEach(id=>{
        const th = document.createElement('th');
        th.className = 'px-3 py-3 text-center font-semibold text-[var(--cfp-ivory)] bg-[var(--cfp-black)] whitespace-nowrap align-middle font-[Oswald] tracking-wide';

        const row = (gameRows||[]).find(g=>g.GameId===id);

        // Title: link to espn_url if present
        const hasUrl = !!(row?.espn_url && /^https?:\/\//i.test(row.espn_url));
        const title = document.createElement(hasUrl ? 'a' : 'div');
        title.className = 'mb-1';
        title.textContent = gameNameMap[id] || `Game ${id}`;
        if (hasUrl) {
          title.href = row.espn_url.trim();
          title.target = '_blank';
          title.rel = 'noopener noreferrer';
          title.className = 'mb-1 text-[var(--cfp-ivory)] hover:underline underline-offset-2';
        }
        th.appendChild(title);

        const networkLine = document.createElement('div');
        networkLine.className = 'network-line';

        const badge = document.createElement('div');
        badge.className = 'badge badge-sched inline-fix';

        if(row?.Status === 'final'){
          networkLine.style.display = 'none';
          const a = row.AwayPts ?? '';
          const h = row.HomePts ?? '';
          badge.textContent = `Final ${a}‚Äì${h}`;
          badge.className = 'badge badge-final inline-fix';
        } else if(row?.Status === 'in_progress'){
          if (row?.Network) { networkLine.textContent = row.Network; networkLine.style.display=''; }
          else { networkLine.style.display='none'; }

          const p = row?.Period || 1;
          const clk = row?.Clock || '';
          const a = row?.AwayPts ?? '';
          const h = row?.HomePts ?? '';
          const score = (a!=='' && h!=='') ? `${a}‚Äì${h}` : '';
          badge.textContent = `${p >= 5 ? 'OT' : 'Q'+(p||1)} ${clk} ${score}`.trim();
          badge.className = 'badge badge-live inline-fix';
        } else {
          if (row?.Network) { networkLine.textContent = row.Network; networkLine.style.display=''; }
          else { networkLine.style.display='none'; }
          const t = formatTimeLocal(row && row['Start (CT)']);
          badge.textContent = t || 'Scheduled';
          badge.className = 'badge badge-sched inline-fix';
        }

        const statusWrap = document.createElement('div');
        statusWrap.className = 'flex items-center justify-center gap-1 w-full text-center whitespace-nowrap';
        statusWrap.appendChild(networkLine);
        statusWrap.appendChild(badge);
        th.appendChild(statusWrap);

        headerStatusEls.set(String(id), { badgeEl: badge, networkEl: networkLine });
        theadRow.appendChild(th);
      });
    }

    function renderTable(teams, pickMap, winnerMap, revealPicks){
      tbody.innerHTML = '';

      const pointsArray = teams.map(t => winsByTeam[t.team_id] || 0);
      const cutoffPts = pointsArray.length ? (pointsArray[Math.min(3, pointsArray.length - 1)] || 0) : 0;

      let lastCutIndex = -1;
      for(let i = 0; i < teams.length; i++){
        if((winsByTeam[teams[i].team_id] || 0) >= cutoffPts){
          lastCutIndex = i;
        } else break;
      }

      const shouldInsertDivider = lastCutIndex >= 0 && lastCutIndex < teams.length - 1;

      teams.forEach((team, idx)=>{
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.08)]';

        // üîπ Mark logged-in user's team row
        if (currentTeamId != null && team.team_id === currentTeamId) {
          tr.dataset.me = 'true';
        }

        const tdTeam = document.createElement('td');
        tdTeam.className = 'pl-4 pr-2 py-2 font-semibold text-[var(--cfp-ivory)] sticky-col-1';
        tdTeam.textContent = team.team_name;
        tr.appendChild(tdTeam);

        const tdPts = document.createElement('td');
        tdPts.className = 'pl-2 pr-3 py-2 text-center font-semibold text-[var(--cfp-ivory)]';
        tdPts.textContent = (winsByTeam[team.team_id] || 0).toString();
        tr.appendChild(tdPts);

        gameIds.forEach(id=>{
          const td = document.createElement('td');
          td.className = 'px-3 py-2 text-center text-sm align-middle';

          if(!revealPicks){
            td.classList.add('pick-empty');
            td.textContent = '‚Äî';
            tr.appendChild(td);
            return;
          }

          const pick   = pickMap[team.team_id]?.[id];
          const winner = winnerMap[id];
          const hasPick = !!(pick && String(pick).trim() !== '');

          if(hasPick){
            if(winner && sameTeam(pick, winner)){
              td.classList.add('pick-win');
            }else if(winner && !sameTeam(pick, winner)){
              td.classList.add('pick-loss');
            }else{
              td.classList.add('pick-empty');
            }
          }else{
            td.classList.add('pick-empty');
          }

          const url = hasPick ? getLogoForPickExact(pick) : null;
          if(url){
            const img = document.createElement('img');
            img.src = url;
            img.alt = pick;
            img.title = pick;
            img.loading = 'lazy';
            img.className = 'logo';
            td.appendChild(img);
          }else{
            td.textContent = hasPick ? pick : '‚Äî';
          }

          tr.appendChild(td);
        });

        tbody.appendChild(tr);

        if(shouldInsertDivider && idx === lastCutIndex){
          const divTr = document.createElement('tr');
          divTr.className = 'playoff-divider';
          const divTd = document.createElement('td');
          divTd.colSpan = 2 + gameIds.length;
          divTd.textContent = 'Projected Playoff Table (Kids‚Äô Table Below)';
          divTr.appendChild(divTd);
          tbody.appendChild(divTr);
        }
      });
    }

    // ------- Weekly Submissions -------
    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // COMPLETE submission rule: must have a non-empty pick for EVERY game in gameIds
    function renderWeeklySubmissions(teams, pickMap){
      const made = [];
      const notYet = [];

      teams.forEach(t=>{
        const picks = pickMap[t.team_id] || {};
        const hasCompleteSubmission = gameIds.length === 0 ? false : gameIds.every(id=>{
          const p = picks[id];
          return p && String(p).trim() !== '';
        });
        (hasCompleteSubmission ? made : notYet).push(t.team_name);
      });

      wsMade.innerHTML = made.map(name =>
        `<span class="badge badge-sched inline-fix rounded-full bg-[linear-gradient(135deg,#824026,#c56a30)] text-[var(--cfp-ivory)] border border-amber-200/40">ü¶É ${escapeHtml(name)}</span>`
      ).join('') || `<span class="text-amber-100/70">No plates piled high just yet.</span>`;

      wsNot.innerHTML = notYet.map(name =>
        `<span class="badge badge-sched inline-fix rounded-full bg-[linear-gradient(135deg,#3a2517,#1f130b)] text-amber-100/90 border border-amber-50/30">ü•Ñ ${escapeHtml(name)}</span>`
      ).join('') || `<span class="text-amber-100/70">Everyone‚Äôs plate is full. Beautiful.</span>`;
    }

    // ------- LIVE TICKER -------
    async function startLiveTicker(){
      await refreshBadgesFromAllGames();
      liveTimer = setInterval(refreshBadgesFromAllGames, LIVE_INTERVAL_MS);
    }
    function stopLiveTicker(){
      if(liveTimer){ clearInterval(liveTimer); liveTimer = null; }
    }

    async function refreshBadgesFromAllGames(){
      if(!gameIds || !gameIds.length) return;

      const { data: rows, error } = await supabase
        .from('all_games')
        .select('GameId, Status, AwayPts, HomePts, Period, Clock, "Start (CT)", Network, winner')
        .in('GameId', gameIds);

      if(error){
        console.warn('all_games refresh error:', error.message);
        return;
      }

      let winnerChanged = false;

      (rows || []).forEach(r=>{
        const entry = headerStatusEls.get(String(r.GameId));
        if(!entry) return;

        const { badgeEl, networkEl } = entry;

        if(r.Status === 'final'){
          if (networkEl) networkEl.style.display = 'none';
          const a = r.AwayPts ?? '';
          const h = r.HomePts ?? '';
          badgeEl.textContent = `Final ${a}‚Äì${h}`;
          badgeEl.className = 'badge badge-final inline-fix';
        }else if(r.Status === 'in_progress'){
          if (networkEl) {
            if (r.Network) { networkEl.textContent = r.Network; networkEl.style.display = ''; }
            else { networkEl.style.display = 'none'; }
          }
          const p = r.Period || 1;
          const clk = r.Clock || '';
          const a = r.AwayPts ?? '';
          const h = r.HomePts ?? '';
          const score = (a!=='' && h!=='') ? `${a}‚Äì${h}` : '';
          badgeEl.textContent = `${p >= 5 ? 'OT' : 'Q'+(p||1)} ${clk} ${score}`.trim();
          badgeEl.className = 'badge badge-live inline-fix';
        }else{
          if (networkEl) {
            if (r.Network) { networkEl.textContent = r.Network; networkEl.style.display = ''; }
            else { networkEl.style.display = 'none'; }
          }
          const t = formatTimeLocal(r['Start (CT)']);
          badgeEl.textContent = t || 'Scheduled';
          badgeEl.className = 'badge badge-sched inline-fix';
        }

        const prevWinner = winnerMap[r.GameId] ?? null;
        const currWinner = r.winner ?? null;
        if (prevWinner !== currWinner) {
          winnerMap[r.GameId] = currWinner;
          winnerChanged = true;
        }
      });

      if (!showPicks && weekStartTs && Date.now() >= weekStartTs) {
        showPicks = true;
        status(`Kickoff! The feast is served for Season ${currentSeason} ‚Ä¢ Week ${currentWeek}.`);
        winnerChanged = true;
      }

      if (winnerChanged) {
        await computeSeasonWins();

        lastTeams.sort((a,b)=>{
          const pa = winsByTeam[a.team_id] || 0;
          const pb = winsByTeam[b.team_id] || 0;
          if (pb !== pa) return pb - pa;
          return a.team_name.localeCompare(b.team_name);
        });

        renderTable(lastTeams, lastPickMap, winnerMap, showPicks);
        renderWeeklySubmissions(lastTeams, lastPickMap);
      }
    }
  </script>
</body>
</html>