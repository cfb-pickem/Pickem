<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em — Commissioner</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root {
      --cfp-black:#0B0B0B;
      --cfp-charcoal:#111213;
      --cfp-gold:#C99210;
      --cfp-gold-2:#E3B23C;
      --cfp-ivory:#F7F4ED;
      --cfp-gray:#1F2022;
      --ring: 0 0 0 2px var(--cfp-gold) inset, 0 0 0 2px var(--cfp-gold);
    }
    body {
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(201,146,16,.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.03) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      background-size:100% 100%,24px 24px,auto;
      color:#e7e7e7;
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      min-height:100vh;
    }
    .cfp-card{background:linear-gradient(180deg,var(--cfp-black),var(--cfp-gray));border:1px solid rgba(231,231,231,.10)}
    .cfp-select{background:var(--cfp-black);color:#f1f1f1;border:1px solid rgba(231,231,231,.12)}
    .cfp-select:focus{outline:none;box-shadow:var(--ring)}
    .gold-shadow{box-shadow:0 0 0 1px rgba(233,185,73,.35),0 0 24px rgba(233,185,73,.08) inset}
    .table th,.table td{border-color:rgba(231,231,231,.08)}
    .table tbody tr:hover{background:rgba(233,185,73,.06)}
    .ring-gold{box-shadow:var(--ring)}
    .dirty{outline:2px dashed var(--cfp-gold-2); outline-offset:2px}
  </style>
</head>

<body data-page="commissioner">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div id="site-nav"></div>

    <header class="cfp-card rounded-none gold-shadow mb-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 px-4 py-4 md:px-6 md:py-5">
        <div>
          <p class="text-[11px] tracking-[.25em] text-gray-300 uppercase">College Football Pick'em</p>
          <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">
            Commissioner Dashboard
          </h1>
          <p class="text-xs text-gray-300 mt-1">Select weekly games, set the lines, and track pick submissions.</p>
        </div>
        <div class="flex items-center gap-3">
          <label class="hidden md:block text-gray-300">Week</label>
          <select id="week-select" class="cfp-select rounded-none px-3 py-2 text-sm"></select>
        </div>
      </div>
      <div class="border-t border-[rgba(231,231,231,.08)] px-4 md:px-6 py-2 text-xs text-gray-300">
        <span id="status">Loading…</span>
      </div>
    </header>

    <div id="auth-gate" class="cfp-card gold-shadow p-4 md:p-6 hidden">
      <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl text-[var(--cfp-ivory)] mb-2">Commissioner access only</h2>
      <p class="text-sm text-gray-200">
        You must be signed in as a commissioner to view this page.
      </p>
    </div>

    <div id="main" class="hidden">
      <div class="cfp-card gold-shadow rounded-none overflow-auto">
        <table class="table min-w-full text-sm" id="games-table">
          <thead class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Picked</th>
              <th class="px-3 py-2 text-left font-semibold">Away</th>
              <th class="px-3 py-2 text-left font-semibold">Home</th>
              <th class="px-3 py-2 text-left font-semibold">Line</th>
              <th class="px-3 py-2 text-left font-semibold">Kick (CT)</th>
              <th class="px-3 py-2 text-left font-semibold">Picks In</th>
              <th class="px-3 py-2 text-left font-semibold">ESPN</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center gap-3">
        <button id="save" class="px-4 py-2 bg-[var(--cfp-gold)] text-black font-semibold ring-gold">Save Changes</button>
        <button id="revert" class="px-4 py-2 border border-white/15">Revert Unsaved</button>
        <span id="dirty-indicator" class="text-xs text-[var(--cfp-gold-2)] hidden">You have unsaved changes.</span>
      </div>
    </div>
  </div>

  <script type="module">
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    // ---- DOM elements ----
    const weekSelect = document.getElementById('week-select');
    const statusEl   = document.getElementById('status');
    const tbody      = document.getElementById('tbody');
    const main       = document.getElementById('main');
    const authGate   = document.getElementById('auth-gate');
    const saveBtn    = document.getElementById('save');
    const revertBtn  = document.getElementById('revert');
    const dirtyNote  = document.getElementById('dirty-indicator');

    // ---- State ----
    let session = null;
    let currentWeek = null;
    let rows = [];
    let baseline = [];
    let picksCountByGame = new Map();
    let totalTeams = 0;
    let isCommissioner = false;

    function setStatus(msg, isErr=false){
      statusEl.className = 'text-xs ' + (isErr ? 'text-red-300' : 'text-gray-300');
      statusEl.textContent = msg || '';
    }
    function kickoffCT(ts){
      if(!ts) return '';
      try { return new Date(ts).toLocaleString([], { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }); }
      catch { return ts; }
    }
    function markDirtyUI(){
      const dirty = JSON.stringify(rows) !== JSON.stringify(baseline);
      dirtyNote.classList.toggle('hidden', !dirty);
      saveBtn.disabled = !dirty;
      revertBtn.disabled = !dirty;
    }

    async function requireCommissioner(){
      const { data: { session: s } } = await supabase.auth.getSession();
      session = s || null;
      const email = session?.user?.email?.toLowerCase?.() || '';
      if (!session) return false;

      const { data: teamRow, error } = await supabase
        .from('teams')
        .select('commissioner')
        .eq('email', email)
        .single();

      if (!error && teamRow?.commissioner === true) {
        isCommissioner = true;
      }

      if (!isCommissioner) {
        main.classList.add('hidden');
        authGate.classList.remove('hidden');
        setStatus('');
        return false;
      }
      authGate.classList.add('hidden');
      main.classList.remove('hidden');
      return true;
    }

    async function init(){
      await initNav();
      if(!await requireCommissioner()) return;
      await boot();
    }
    init();

    async function boot(){
      setStatus('Loading weeks…');
      const [{ data: weekRows, error: wErr }, { data: teamRows, error: tErr }] = await Promise.all([
        supabase.from('all_games').select('week').not('week', 'is', null).order('week', { ascending: true }),
        supabase.from('teams').select('team_id')
      ]);
      if (wErr){ setStatus(wErr.message, true); return; }
      if (tErr){ setStatus(tErr.message, true); return; }

      const weeks = [...new Set((weekRows||[]).map(r => Number(r.week)))].sort((a,b)=>a-b);
      if (!weeks.length){ setStatus('No weeks found.', true); return; }

      totalTeams = (teamRows || []).length;
      weekSelect.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
      currentWeek = weeks[weeks.length-1];
      weekSelect.value = String(currentWeek);
      weekSelect.onchange = async () => {
        currentWeek = Number(weekSelect.value);
        await loadWeek(currentWeek);
      };
      await loadWeek(currentWeek);
      setStatus('');
    }

    async function loadWeek(week){
      setStatus('Loading games…');
      tbody.innerHTML = '';
      const { data: gameRows, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, line, picked, "Start (CT)", espn_url')
        .eq('week', week);
      if (gErr){ setStatus(gErr.message, true); return; }

      rows = (gameRows||[]).map(r => ({
        GameId: r.GameId,
        Away: r.Away,
        Home: r.Home,
        line: (r.line == null ? null : Number(r.line)),
        picked: !!r.picked,
        start: r['Start (CT)'],
        espn_url: r.espn_url || null
      })).sort((a,b)=>{
        const ta = a.start ? new Date(a.start).getTime() : Infinity;
        const tb = b.start ? new Date(b.start).getTime() : Infinity;
        return ta - tb;
      });
      baseline = JSON.parse(JSON.stringify(rows));

      const { data: picks, error: pErr } = await supabase
        .from('picks')
        .select('game_id, team_id')
        .eq('week', week);
      if (pErr){ setStatus(pErr.message, true); return; }

      picksCountByGame = new Map();
      (picks || []).forEach(r => {
        const key = String(r.game_id);
        picksCountByGame.set(key, (picksCountByGame.get(key) || 0) + 1);
      });
      renderTable();
      setStatus(`Week ${week} • ${rows.length} games`);
      markDirtyUI();
    }

    function renderTable(){
      tbody.innerHTML = '';
      rows.forEach((g, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)]';

        const tdPick = document.createElement('td');
        tdPick.className = 'px-3 py-2';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = g.picked;
        cb.addEventListener('change', () => { g.picked = cb.checked; tr.classList.add('dirty'); markDirtyUI(); });
        tdPick.appendChild(cb);
        tr.appendChild(tdPick);

        const tdAway = document.createElement('td');
        tdAway.className = 'px-3 py-2'; tdAway.textContent = g.Away; tr.appendChild(tdAway);
        const tdHome = document.createElement('td');
        tdHome.className = 'px-3 py-2'; tdHome.textContent = g.Home; tr.appendChild(tdHome);

        const tdLine = document.createElement('td');
        tdLine.className = 'px-3 py-2';
        const inp = document.createElement('input');
        inp.type = 'number'; inp.step = '0.5'; inp.className = 'w-24 bg-black/40 border border-white/10 rounded px-2 py-1';
        inp.value = (g.line ?? '').toString();
        inp.addEventListener('input', () => { g.line = inp.value ? Number(inp.value) : null; tr.classList.add('dirty'); markDirtyUI(); });
        tdLine.appendChild(inp); tr.appendChild(tdLine);

        const tdStart = document.createElement('td');
        tdStart.className = 'px-3 py-2 whitespace-nowrap'; tdStart.textContent = kickoffCT(g.start); tr.appendChild(tdStart);

        const tdPicks = document.createElement('td');
        tdPicks.className = 'px-3 py-2';
        const got = picksCountByGame.get(String(g.GameId)) || 0;
        tdPicks.textContent = totalTeams ? `${got}/${totalTeams}` : String(got);
        tr.appendChild(tdPicks);

        const tdLink = document.createElement('td');
        tdLink.className = 'px-3 py-2';
        if (g.espn_url){
          const a = document.createElement('a');
          a.href = g.espn_url; a.target = '_blank'; a.rel = 'noopener';
          a.className = 'text-[var(--cfp-gold-2)] underline'; a.textContent = 'Matchup';
          tdLink.appendChild(a);
        } else tdLink.textContent = '—';
        tr.appendChild(tdLink);
        tbody.appendChild(tr);
      });
    }

    function diffRows(){
      const diffs = [];
      rows.forEach((g, i) => {
        const b = baseline[i];
        if (!b) return;
        const changed = (g.picked !== b.picked) || ((g.line ?? null) !== (b.line ?? null));
        if (changed) diffs.push({ GameId: g.GameId, picked: g.picked, line: g.line });
      });
      return diffs;
    }

    revertBtn.addEventListener('click', () => {
      rows = JSON.parse(JSON.stringify(baseline));
      renderTable();
      markDirtyUI();
    });

    saveBtn.addEventListener('click', async () => {
      const updates = diffRows();
      if (!updates.length){ setStatus('No changes to save.'); return; }

      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving…';
      try{
        const tasks = updates.map(up =>
          supabase.from('all_games').update({ picked: up.picked, line: up.line }).eq('GameId', up.GameId)
        );
        const res = await Promise.all(tasks);
        const err = res.find(r => r.error)?.error;
        if (err) throw err;
        baseline = JSON.parse(JSON.stringify(rows));
        document.querySelectorAll('#tbody tr').forEach(tr => tr.classList.remove('dirty'));
        markDirtyUI();
        setStatus('Saved changes.');
      } catch(e){
        console.error(e);
        setStatus('Save failed: ' + (e?.message || 'Unknown error'), true);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    });
  </script>
</body>
</html>