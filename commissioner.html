<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em — Commissioner</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root{
      --cfp-black:#0B0B0B; --cfp-charcoal:#111213; --cfp-gold:#C99210; --cfp-gold-2:#E3B23C;
      --cfp-ivory:#F7F4ED; --cfp-gray:#1F2022; --ring:0 0 0 2px var(--cfp-gold) inset,0 0 0 2px var(--cfp-gold);
    }
    body{
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(201,146,16,.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.03) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      background-size:100% 100%,24px 24px,auto;
      color:#e7e7e7; font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif; min-height:100vh;
    }
    .cfp-card{background:linear-gradient(180deg,var(--cfp-black),var(--cfp-gray));border:1px solid rgba(231,231,231,.10)}
    .gold-shadow{box-shadow:0 0 0 1px rgba(233,185,73,.35),0 0 24px rgba(233,185,73,.08) inset}
    .table th,.table td{border-color:rgba(231,231,231,.08)}
    .table tbody tr:hover{background:rgba(233,185,73,.06)}
    .ring-gold{box-shadow:var(--ring)}
    .dirty{outline:2px dashed var(--cfp-gold-2); outline-offset:2px}
    .chip{font-size:11px;padding:.2rem .45rem;border:1px solid rgba(231,231,231,.15);border-radius:6px}
  </style>
</head>

<body data-page="commissioner">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <div id="site-nav"></div>

    <!-- Header -->
    <header class="cfp-card rounded-none gold-shadow mb-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 px-4 py-4 md:px-6 md:py-5">
        <div>
          <p class="text-[11px] tracking-[.25em] text-gray-300 uppercase">College Football Pick'em</p>
          <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">
            Commissioner Dashboard
          </h1>
          <p class="text-xs text-gray-300 mt-1">Select games, set lines, track submissions — and edit team picks.</p>
        </div>
        <div class="flex items-center gap-3">
          <label class="hidden md:block text-gray-300">Week</label>
          <select id="week-select" class="bg-black/50 border border-white/10 px-3 py-2 text-sm"></select>
        </div>
      </div>
      <div class="border-t border-[rgba(231,231,231,.08)] px-4 md:px-6 py-2 text-xs text-gray-300">
        <span id="status">Loading…</span>
      </div>
    </header>

    <!-- Auth gate -->
    <div id="auth-gate" class="cfp-card gold-shadow p-4 md:p-6 hidden">
      <h2 class="font-['Oswald',_sans-serif] text-xl md:text-2xl text-[var(--cfp-ivory)] mb-2">Commissioner access only</h2>
      <p class="text-sm text-gray-200">You must be signed in as a commissioner to view this page.</p>
    </div>

    <div id="main" class="hidden space-y-6">

      <!-- Edit Team Picks (moved ABOVE games table) -->
      <section class="cfp-card gold-shadow rounded-none">
        <div class="px-4 md:px-6 py-4 flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
          <div class="space-y-2">
            <h3 class="font-['Oswald'] text-xl text-[var(--cfp-ivory)]">Edit Team Picks</h3>
            <p class="text-xs text-gray-300">Select a team and week, then set their picks for each <span class="italic">picked</span> game.</p>
          </div>
          <div class="flex flex-wrap items-end gap-3">
            <div>
              <label class="block text-xs text-gray-300 mb-1">Team</label>
              <select id="team-select" class="bg-black/50 border border-white/10 px-3 py-2 text-sm min-w-[220px]"></select>
            </div>
            <div>
              <label class="block text-xs text-gray-300 mb-1">Week</label>
              <select id="edit-week-select" class="bg-black/50 border border-white/10 px-3 py-2 text-sm"></select>
            </div>
            <button id="load-team-picks" class="px-3 py-2 border border-white/15">Load</button>
          </div>
        </div>

        <div class="overflow-auto">
          <table class="table min-w-full text-sm">
            <thead class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
              <tr>
                <th class="px-3 py-2 text-left font-semibold">Away</th>
                <th class="px-3 py-2 text-left font-semibold">Home</th>
                <th class="px-3 py-2 text-left font-semibold">Line</th>
                <th class="px-3 py-2 text-left font-semibold">Kick (CT)</th>
                <th class="px-3 py-2 text-left font-semibold">Pick</th>
              </tr>
            </thead>
            <tbody id="tp-body"></tbody>
          </table>
        </div>

        <div class="px-4 md:px-6 py-3 flex items-center gap-3">
          <button id="tp-save" class="px-4 py-2 bg-[var(--cfp-gold)] text-black font-semibold ring-gold">Save Team Picks</button>
          <span id="tp-status" class="text-xs text-gray-300"></span>
        </div>
      </section>

      <!-- Weekly Games/Lines -->
      <section class="cfp-card gold-shadow rounded-none overflow-auto">
        <div class="px-4 md:px-6 py-3 flex items-center gap-3">
          <h3 class="font-['Oswald'] text-xl text-[var(--cfp-ivory)]">Weekly Games</h3>
          <span class="chip" id="games-meta"></span>
          <span class="text-xs text-[var(--cfp-gold-2)] hidden" id="dirty-indicator">You have unsaved changes.</span>
        </div>
        <table class="table min-w-full text-sm" id="games-table">
          <thead class="bg-[var(--cfp-black)] text-[var(--cfp-ivory)]">
            <tr>
              <th class="px-3 py-2 text-left font-semibold">Picked</th>
              <th class="px-3 py-2 text-left font-semibold">Away</th>
              <th class="px-3 py-2 text-left font-semibold">Home</th>
              <th class="px-3 py-2 text-left font-semibold">Line</th>
              <th class="px-3 py-2 text-left font-semibold">Kick (CT)</th>
              <th class="px-3 py-2 text-left font-semibold">Picks In</th>
              <th class="px-3 py-2 text-left font-semibold">ESPN</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="px-4 md:px-6 py-3 flex items-center gap-3">
          <button id="save" class="px-4 py-2 bg-[var(--cfp-gold)] text-black font-semibold ring-gold">Save Changes</button>
          <button id="revert" class="px-4 py-2 border border-white/15">Revert Unsaved</button>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    // --- DOM refs (weekly games/lines) ---
    const weekSelect   = document.getElementById('week-select');
    const statusEl     = document.getElementById('status');
    const gamesMeta    = document.getElementById('games-meta');
    const tbody        = document.getElementById('tbody');
    const main         = document.getElementById('main');
    const authGate     = document.getElementById('auth-gate');
    const saveBtn      = document.getElementById('save');
    const revertBtn    = document.getElementById('revert');
    const dirtyNote    = document.getElementById('dirty-indicator');

    // --- DOM refs (team picks editor) ---
    const teamSelect   = document.getElementById('team-select');
    const editWeekSel  = document.getElementById('edit-week-select');
    const loadBtn      = document.getElementById('load-team-picks');
    const tpBody       = document.getElementById('tp-body');
    const tpSaveBtn    = document.getElementById('tp-save');
    const tpStatus     = document.getElementById('tp-status');

    // --- State ---
    let session = null;
    let currentWeek = null;
    let rows = [];                 // weekly games
    let picksCountByGame = new Map();
    let totalTeams = 0;

    // order-agnostic baseline for revert/diff
    let baselineRows = [];
    let baselineById = new Map();  // GameId -> {picked, line}

    // team-picks editor state
    let tpGames = [];           // picked games for edit-week
    let tpExisting = new Map(); // game_id -> pick

    // --- Helpers ---
    function setStatus(msg, isErr=false){
      statusEl.className = 'text-xs ' + (isErr ? 'text-red-300' : 'text-gray-300');
      statusEl.textContent = msg || '';
    }
    function kickoffCT(ts){
      if(!ts) return '';
      try { return new Date(ts).toLocaleString([], { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' }); }
      catch { return ts; }
    }
    function sortRowsByPickedThenTime(arr){
      return arr.sort((a,b)=>{
        if (a.picked !== b.picked) return a.picked ? -1 : 1;
        const ta = a.start ? new Date(a.start).getTime() : Infinity;
        const tb = b.start ? new Date(b.start).getTime() : Infinity;
        return ta - tb;
      });
    }
    function rebuildBaseline(){
      baselineRows = JSON.parse(JSON.stringify(rows));
      baselineById = new Map(baselineRows.map(r => [r.GameId, { picked: r.picked, line: r.line }]));
    }
    function isDirty(){
      for (const g of rows){
        const b = baselineById.get(g.GameId);
        if (!b) return true;
        if (g.picked !== b.picked) return true;
        if ((g.line ?? null) !== (b.line ?? null)) return true;
      }
      return false;
    }
    function markDirtyUI(){
      const dirty = isDirty();
      dirtyNote.classList.toggle('hidden', !dirty);
      saveBtn.disabled = !dirty;
      revertBtn.disabled = !dirty;
    }

    // --- Commissioner gate: user must be on a team row with commissioner=true ---
    async function requireCommissioner(){
      const { data: { session: s } } = await supabase.auth.getSession();
      session = s || null;

      if (!session) {
        window.location.href = './index.html';
        return false;
      }

      const userId = session.user.id;
      const { data: teamRow, error } = await supabase
        .from('teams')
        .select('commissioner')
        .eq('user_id', userId)
        .single();

      const ok = !error && teamRow?.commissioner === true;

      if (!ok) {
        main.classList.add('hidden');
        authGate.classList.remove('hidden');
        setStatus('');
        window.location.href = './index.html';
        return false;
      }

      authGate.classList.add('hidden');
      main.classList.remove('hidden');
      setStatus('');
      return true;
    }

    async function init(){
      await initNav();
      if(!await requireCommissioner()) return;
      await boot();
    }
    init();

    // ---------- Boot ----------
    async function boot(){
      setStatus('Loading weeks & teams…');

      const [{ data: weekRows, error: wErr }, { data: teamRows, error: tErr }] = await Promise.all([
        supabase.from('all_games').select('week').not('week', 'is', null).order('week', { ascending: true }),
        supabase.from('teams').select('team_id, team_name').order('team_name', { ascending: true })
      ]);
      if (wErr){ setStatus(wErr.message, true); return; }
      if (tErr){ setStatus(tErr.message, true); return; }

      const weeks = [...new Set((weekRows||[]).map(r => Number(r.week)))].sort((a,b)=>a-b);
      if (!weeks.length){ setStatus('No weeks found.', true); return; }
      totalTeams = (teamRows || []).length;

      weekSelect.innerHTML  = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join('');
      editWeekSel.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join('');

      // default to latest week
      currentWeek = weeks[weeks.length-1];
      weekSelect.value = String(currentWeek);
      editWeekSel.value = String(currentWeek);

      // Teams dropdown
      teamSelect.innerHTML = (teamRows||[])
        .map(t => `<option value="${t.team_id}">${t.team_name ?? ('Team ' + t.team_id)}</option>`)
        .join('');

      // Wire up selectors
      weekSelect.onchange   = async () => { currentWeek = Number(weekSelect.value); await loadWeek(currentWeek); };
      editWeekSel.onchange  = loadTeamPicks;  // immediately switches week in team editor
      loadBtn.addEventListener('click', loadTeamPicks);
      tpSaveBtn.addEventListener('click', saveTeamPicks);

      await loadWeek(currentWeek);
      await loadTeamPicks();
      setStatus('');
    }

    // ---------- Weekly games/lines ----------
    async function loadWeek(week){
      setStatus('Loading games…');
      tbody.innerHTML = '';
      const { data: gameRows, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, line, picked, "Start (CT)", espn_url')
        .eq('week', week);
      if (gErr){ setStatus(gErr.message, true); return; }

      rows = (gameRows||[]).map(r => ({
        GameId: r.GameId, Away: r.Away, Home: r.Home,
        line: (r.line == null ? null : Number(r.line)),
        picked: !!r.picked, start: r['Start (CT)'], espn_url: r.espn_url || null
      }));

      // Picked first, then by kickoff
      sortRowsByPickedThenTime(rows);

      // Picks count
      const { data: picks, error: pErr } = await supabase
        .from('picks')
        .select('game_id, team_id')
        .eq('week', week);
      if (pErr){ setStatus(pErr.message, true); return; }

      picksCountByGame = new Map();
      (picks || []).forEach(r => {
        const key = String(r.game_id);
        picksCountByGame.set(key, (picksCountByGame.get(key) || 0) + 1);
      });

      // Baseline AFTER sorting (order-agnostic map)
      rebuildBaseline();

      renderGamesTable();
      gamesMeta.textContent = `Week ${week} • ${rows.length} games`;
      markDirtyUI();
    }

    function renderGamesTable(){
      tbody.innerHTML = '';
      rows.forEach((g) => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)]';

        // Picked
        const tdPick = document.createElement('td');
        tdPick.className = 'px-3 py-2 align-middle';
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.checked = g.picked;
        cb.addEventListener('change', () => {
          g.picked = cb.checked;
          // re-sort to pin/unpin
          sortRowsByPickedThenTime(rows);
          renderGamesTable();
          markDirtyUI();
        });
        tdPick.appendChild(cb); tr.appendChild(tdPick);

        // Away / Home
        const tdAway = document.createElement('td'); tdAway.className = 'px-3 py-2'; tdAway.textContent = g.Away || ''; tr.appendChild(tdAway);
        const tdHome = document.createElement('td'); tdHome.className = 'px-3 py-2'; tdHome.textContent = g.Home || ''; tr.appendChild(tdHome);

        // Line
        const tdLine = document.createElement('td'); tdLine.className = 'px-3 py-2';
        const inp = document.createElement('input'); inp.type = 'number'; inp.step='0.5';
        inp.className='w-24 bg-black/40 border border-white/10 rounded px-2 py-1';
        inp.value = (g.line ?? '').toString();
        inp.placeholder='—';
        inp.addEventListener('input', () => { g.line = inp.value === '' ? null : Number(inp.value); tr.classList.add('dirty'); markDirtyUI(); });
        tdLine.appendChild(inp); tr.appendChild(tdLine);

        // Start time
        const tdStart = document.createElement('td'); tdStart.className='px-3 py-2 whitespace-nowrap'; tdStart.textContent = kickoffCT(g.start) || ''; tr.appendChild(tdStart);

        // Picks in
        const tdPicks = document.createElement('td'); tdPicks.className='px-3 py-2';
        const got = picksCountByGame.get(String(g.GameId)) || 0;
        tdPicks.textContent = totalTeams ? `${got}/${totalTeams}` : String(got);
        tr.appendChild(tdPicks);

        // ESPN
        const tdLink = document.createElement('td'); tdLink.className='px-3 py-2';
        if (g.espn_url){
          const a = document.createElement('a'); a.href=g.espn_url; a.target='_blank'; a.rel='noopener';
          a.className='text-[var(--cfp-gold-2)] underline'; a.textContent='Matchup';
          tdLink.appendChild(a);
        } else { tdLink.textContent='—'; }
        tr.appendChild(tdLink);

        tbody.appendChild(tr);
      });
    }

    function diffRows(){
      const diffs = [];
      for (const g of rows){
        const b = baselineById.get(g.GameId) || {};
        const changed = (g.picked !== b.picked) || ((g.line ?? null) !== (b.line ?? null));
        if (changed){ diffs.push({ GameId: g.GameId, picked: g.picked, line: g.line }); }
      }
      return diffs;
    }

    revertBtn.addEventListener('click', () => {
      rows = JSON.parse(JSON.stringify(baselineRows));
      sortRowsByPickedThenTime(rows);
      renderGamesTable(); markDirtyUI();
    });

    saveBtn.addEventListener('click', async () => {
      const updates = diffRows();
      if (!updates.length){ setStatus('No changes to save.'); return; }
      saveBtn.disabled = true; saveBtn.textContent = 'Saving…';
      try{
        const tasks = updates.map(up =>
          supabase.from('all_games').update({ picked: up.picked, line: up.line }).eq('GameId', up.GameId)
        );
        const res = await Promise.all(tasks);
        const err = res.find(r => r.error)?.error; if (err) throw err;
        rebuildBaseline();
        document.querySelectorAll('#tbody tr').forEach(tr => tr.classList.remove('dirty'));
        markDirtyUI(); setStatus('Saved changes.');
      }catch(e){ setStatus('Save failed: ' + (e?.message || 'Unknown error'), true); }
      finally{ saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
    });

    // ---------- Team Picks Editor (picked games only) ----------
    async function loadTeamPicks(){
      tpStatus.textContent = 'Loading…';
      tpBody.innerHTML = '';
      tpExisting.clear();

      const teamId = Number(teamSelect.value);
      const week = Number(editWeekSel.value);

      // Only get PICKED games for the selected week
      const { data: gRows, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, line, "Start (CT)"')
        .eq('week', week)
        .eq('picked', true);
      if (gErr){ tpStatus.textContent = gErr.message; return; }

      tpGames = (gRows||[]).map(r => ({
        game_id: r.GameId, Away: r.Away, Home: r.Home,
        line: (r.line == null ? null : Number(r.line)),
        start: r['Start (CT)']
      })).sort((a,b)=>{
        const ta = a.start ? new Date(a.start).getTime() : Infinity;
        const tb = b.start ? new Date(b.start).getTime() : Infinity;
        return ta - tb;
      });

      // Existing picks for this team/week among those picked games
      const ids = tpGames.map(g => g.game_id);
      if (ids.length){
        const { data: pRows, error: pErr } = await supabase
          .from('picks')
          .select('game_id, pick')
          .eq('team_id', teamId)
          .eq('week', week)
          .in('game_id', ids);
        if (!pErr){
          (pRows||[]).forEach(r => tpExisting.set(String(r.game_id), r.pick));
        }
      }

      renderTeamPicks();
      tpStatus.textContent = `Team ${teamId} • Week ${week} • ${tpGames.length} picked games`;
    }

    function renderTeamPicks(){
      tpBody.innerHTML = '';
      if (!tpGames.length){
        tpBody.innerHTML = `
          <tr class="border-t border-[rgba(231,231,231,.08)]">
            <td colspan="5" class="px-3 py-4 text-sm text-gray-300">No games have been marked as <strong>Picked</strong> for this week.</td>
          </tr>`;
        return;
      }

      tpGames.forEach(g => {
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)]';

        const tdAway = document.createElement('td'); tdAway.className='px-3 py-2'; tdAway.textContent=g.Away; tr.appendChild(tdAway);
        const tdHome = document.createElement('td'); tdHome.className='px-3 py-2'; tdHome.textContent=g.Home; tr.appendChild(tdHome);
        const tdLine = document.createElement('td'); tdLine.className='px-3 py-2'; tdLine.textContent = (g.line ?? '—'); tr.appendChild(tdLine);
        const tdStart= document.createElement('td'); tdStart.className='px-3 py-2 whitespace-nowrap'; tdStart.textContent=kickoffCT(g.start); tr.appendChild(tdStart);

        // Pick controls
        const tdPick = document.createElement('td'); tdPick.className='px-3 py-2';
        const current = tpExisting.get(String(g.game_id)) || null;
        const group = `pick-${g.game_id}`;

        const mkRadio = (val, label) => {
          const id = `${group}-${val||'none'}`;
          const wrap = document.createElement('label'); wrap.className='inline-flex items-center gap-2 mr-3';
          const rb = document.createElement('input'); rb.type='radio'; rb.name=group; rb.value=val??''; rb.checked = (val??null) === current;
          rb.addEventListener('change', () => { tpExisting.set(String(g.game_id), val??null); });
          const span = document.createElement('span'); span.textContent = label;
          wrap.appendChild(rb); wrap.appendChild(span);
          return wrap;
        };
        tdPick.appendChild(mkRadio(g.Away, g.Away));
        tdPick.appendChild(mkRadio(g.Home, g.Home));
        tdPick.appendChild(mkRadio(null, 'Clear'));
        tr.appendChild(tdPick);

        tpBody.appendChild(tr);
      });
    }

    async function saveTeamPicks(){
      const teamId = Number(teamSelect.value);
      const week = Number(editWeekSel.value);
      if (!tpGames.length){ tpStatus.textContent = 'No games to save.'; return; }

      const rows = [];
      tpExisting.forEach((pick, key) => {
        const gameId = Number(key);
        if (pick === null || pick === undefined || pick === '') {
          rows.push({ _delete: true, team_id: teamId, game_id: gameId, week });
        } else {
          rows.push({ team_id: teamId, game_id: gameId, pick, week });
        }
      });

      if (!rows.length){ tpStatus.textContent = 'No changes to save.'; return; }

      tpSaveBtn.disabled = true; tpSaveBtn.textContent = 'Saving…';
      try{
        const delKeys = rows.filter(r => r._delete).map(r => r.game_id);
        if (delKeys.length){
          await supabase.from('picks')
            .delete()
            .eq('team_id', teamId)
            .eq('week', week)
            .in('game_id', delKeys);
        }
        const upserts = rows.filter(r => !r._delete);
        if (upserts.length){
          const { error } = await supabase
            .from('picks')
            .upsert(upserts, { onConflict: 'team_id,game_id', returning: 'minimal' });
          if (error) throw error;
        }

        tpStatus.textContent = 'Saved team picks.';
      } catch(e){
        tpStatus.textContent = 'Save failed: ' + (e?.message || 'Unknown error');
      } finally {
        tpSaveBtn.disabled = false; tpSaveBtn.textContent = 'Save Team Picks';
      }
    }
  </script>
</body>
</html>