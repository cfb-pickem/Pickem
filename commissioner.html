<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CFB Pick'em — Commissioner</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <link rel="modulepreload" href="./js/supabaseClient.js">
  <link rel="modulepreload" href="./js/nav.js">

  <style>
    :root{
      --cfp-black:#0B0B0B; --cfp-charcoal:#111213; --cfp-gold:#C99210; --cfp-gold-2:#E3B23C;
      --cfp-ivory:#F7F4ED; --cfp-gray:#1F2022; --ring:0 0 0 2px var(--cfp-gold) inset,0 0 0 2px var(--cfp-gold);
    }
    body{
      background:
        radial-gradient(1200px 600px at 50% -10%, rgba(201,146,16,.20), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.03) 0 25%, transparent 25% 50%, rgba(255,255,255,.03) 50% 75%, transparent 75% 100%),
        var(--cfp-charcoal);
      color:#e7e7e7; font-family:'Roboto',system-ui,-apple-system,Segoe UI,Arial,sans-serif; min-height:100vh;
    }
    .cfp-card{background:linear-gradient(180deg,var(--cfp-black),var(--cfp-gray));border:1px solid rgba(231,231,231,.10)}
    .ring-gold{box-shadow:var(--ring)}
    .cfp-select{background:var(--cfp-black);color:#f1f1f1;border:1px solid rgba(231,231,231,.12)}
    .cfp-select:focus{outline:none;box-shadow:var(--ring)}
    .table th,.table td{border-color:rgba(231,231,231,.08)}
    .table tbody tr:hover{background:rgba(233,185,73,.06)}
    .pill{display:inline-block;border:1px solid rgba(231,231,231,.14);padding:.2rem .5rem;margin:.15rem;border-radius:999px;background:#141414}
    .num-input{background:#0e0e0f;border:1px solid rgba(231,231,231,.12);padding:.35rem .5rem;width:6rem;text-align:center}
    .num-input:focus{outline:none;box-shadow:var(--ring)}
    .switch{accent-color:var(--cfp-gold)}
  </style>
</head>

<body data-page="commissioner">
  <div class="max-w-6xl mx-auto p-4 md:p-6">
    <div id="site-nav"></div>

    <header class="cfp-card rounded-none ring-gold mb-5">
      <div class="px-4 py-4 md:px-6 md:py-5 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-[11px] tracking-[.25em] text-gray-300 uppercase">College Football Pick'em</p>
          <h1 class="font-['Oswald',_sans-serif] text-3xl md:text-4xl font-bold text-[var(--cfp-ivory)] leading-tight">Commissioner</h1>
        </div>

        <div class="flex flex-wrap gap-3 items-center">
          <label class="text-gray-300">Week</label>
          <select id="week-select" class="cfp-select rounded-none px-3 py-2 text-sm"></select>

          <label class="text-gray-300 ml-2">Team</label>
          <select id="team-select" class="cfp-select rounded-none px-3 py-2 text-sm min-w-[220px]"></select>

          <button id="save-btn" class="bg-[var(--cfp-gold)] text-black font-semibold px-4 py-2 text-sm hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed">
            Save Picks
          </button>
        </div>
      </div>
      <div class="border-t border-[rgba(231,231,231,.08)] px-4 md:px-6 py-2 text-xs text-gray-300">
        <span id="status">Authorizing…</span>
      </div>
    </header>

    <!-- Editable picks table (players' picks managed by commissioner) -->
    <section class="cfp-card overflow-auto mb-6">
      <div class="px-4 py-3 md:px-6 md:py-4 flex items-center justify-between">
        <h2 class="font-['Oswald'] text-2xl">Team Picks Editor</h2>
      </div>
      <table class="table min-w-full text-sm">
        <thead class="bg-[var(--cfp-black)]">
          <tr class="border-b">
            <th class="text-left px-4 py-3 font-semibold text-[var(--cfp-ivory)]">Game</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)]">Pick</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)] w-40">Start (CT)</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)]">Line</th>
          </tr>
        </thead>
        <tbody id="edit-body"></tbody>
      </table>
    </section>

    <!-- Week games management (which games are picked + set lines) -->
    <section class="cfp-card overflow-auto">
      <div class="px-4 py-3 md:px-6 md:py-4 flex items-center justify-between">
        <h2 class="font-['Oswald'] text-2xl">Week Games — Pick & Lines</h2>
        <div class="flex items-center gap-2 text-sm">
          <button id="games-save-btn" class="bg-[var(--cfp-gold)] text-black font-semibold px-4 py-2 hover:opacity-90 disabled:opacity-40 disabled:cursor-not-allowed">
            Save Games
          </button>
        </div>
      </div>

      <table class="table min-w-full text-sm">
        <thead class="bg-[var(--cfp-black)]">
          <tr class="border-b">
            <th class="text-left px-4 py-3 font-semibold text-[var(--cfp-ivory)]">Game</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)] w-40">Start (CT)</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)]">Picked</th>
            <th class="text-center px-3 py-3 font-semibold text-[var(--cfp-ivory)]">Line</th>
          </tr>
        </thead>
        <tbody id="games-body"></tbody>
      </table>
    </section>
  </div>

  <script type="module">
    import initNav from './js/nav.js';
    import { supabase } from './js/supabaseClient.js';

    // DOM
    const weekSel  = document.getElementById('week-select');
    const teamSel  = document.getElementById('team-select');
    const statusEl = document.getElementById('status');
    const tbody    = document.getElementById('edit-body');
    const saveBtn  = document.getElementById('save-btn');

    const gamesTbody = document.getElementById('games-body');
    const gamesSaveBtn = document.getElementById('games-save-btn');

    // State
    let commissionerTeamRow = null;
    let teams = [];
    let gamesThisWeek = []; // picked games for selected week (for picks editor)
    let picksMap = {};      // gameId -> current pick (for the selected team & week)
    let originalPicksMap = {}; // snapshot of picks as loaded to detect changes

    // Admin (games list)
    let adminGames = [];               // all games (picked + not) for the week
    let adminPickedMap = {};           // gameId -> boolean
    let adminLineMap = {};             // gameId -> number|null
    let adminOriginalPickedMap = {};   // snapshot for diffs
    let adminOriginalLineMap = {};     // snapshot for diffs

    function status(msg,isErr=false){
      statusEl.className = 'text-sm ' + (isErr ? 'text-red-300' : 'text-gray-300');
      statusEl.textContent = msg;
    }

    async function gatekeep(){
      await initNav();

      const { data: { user }, error } = await supabase.auth.getUser();
      if(error){ status(error.message, true); return false; }
      if(!user){ status('Please sign in to continue.', true); return false; }

      // Check commissioner flag for this user
      const { data: rows, error: tErr } = await supabase
        .from('teams')
        .select('team_id, team_name, user_id, commissioner')
        .eq('user_id', user.id)
        .eq('commissioner', true);

      if(tErr){ status(tErr.message, true); return false; }
      if(!rows || rows.length === 0){
        status('Access denied — commissioner only.', true);
        weekSel.disabled = teamSel.disabled = saveBtn.disabled = gamesSaveBtn.disabled = true;
        return false;
      }
      commissionerTeamRow = rows[0];
      return true;
    }

    async function bootstrap(){
      status('Loading options…');

      // Weeks (from all_games)
      const { data: weekRows, error: wErr } = await supabase
        .from('all_games')
        .select('week')
        .not('week', 'is', null)
        .order('week', { ascending: true });

      if(wErr) return status(wErr.message, true);
      const weeks = [...new Set((weekRows||[]).map(r=>r.week))].sort((a,b)=>a-b);
      weekSel.innerHTML = weeks.map(w=>`<option value="${w}">Week ${w}</option>`).join('');

      // Teams (all)
      const { data: teamRows, error: tErr } = await supabase
        .from('teams')
        .select('team_id, team_name')
        .order('team_name', { ascending: true });

      if(tErr) return status(tErr.message, true);
      teams = teamRows || [];
      teamSel.innerHTML = teams.map(t=>`<option value="${t.team_id}">${t.team_name}</option>`).join('');

      // Defaults
      if(weeks.length) weekSel.value = String(weeks[weeks.length-1]);
      if(teams.length) teamSel.value = String(teams[0].team_id);

      await refreshAll();
      weekSel.onchange = refreshAll;
      teamSel.onchange = refreshAll;

      saveBtn.onclick = saveAllPicks;
      gamesSaveBtn.onclick = saveGamesAdmin;
    }

    async function refreshAll(){
      const week = Number(weekSel.value);
      const teamId = Number(teamSel.value);
      if(!Number.isFinite(week) || !Number.isFinite(teamId)){
        status('Select a week and a team.');
        return;
      }
      status(`Loading week ${week}…`);

      // Pull picked games for the week (for picks editor)
      const { data: gameRows, error: gErr } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, "Start (CT)", line, week, picked')
        .eq('week', week)
        .eq('picked', true)
        .order('GameId', { ascending: true });

      if(gErr) return status(gErr.message, true);
      gamesThisWeek = gameRows || [];

      // Team’s current picks for that week
      const { data: pickRows, error: pErr } = await supabase
        .from('picks')
        .select('game_id, pick')
        .eq('team_id', teamId)
        .eq('week', week);

      if(pErr) return status(pErr.message, true);

      picksMap = {};
      (pickRows||[]).forEach(r => { picksMap[r.game_id] = r.pick || ''; });
      originalPicksMap = { ...picksMap };

      // Render editor
      renderPicksEditor();

      // Load admin games list (all games for week)
      await refreshGamesAdmin();

      status(`Week ${week} ready.`);
    }

    function niceTime(ts){
      if(!ts) return '';
      try{
        const d = new Date(ts);
        return d.toLocaleString('en-US', { weekday:'short', hour:'2-digit', minute:'2-digit' });
      }catch{ return ''; }
    }

    /* --------- Picks Editor (team picks) ---------- */
    function renderPicksEditor(){
      tbody.innerHTML = '';
      if(!gamesThisWeek.length){
        tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-gray-300">No picked games for this week.</td></tr>`;
        return;
      }

      for(const g of gamesThisWeek){
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]';

        // Game
        const tdGame = document.createElement('td');
        tdGame.className = 'px-4 py-2 font-medium text-[var(--cfp-ivory)]';
        tdGame.textContent = `${g.Away} @ ${g.Home}`;
        tr.appendChild(tdGame);

        // Pick radios
        const tdPick = document.createElement('td');
        tdPick.className = 'px-3 py-2 text-center';
        tdPick.innerHTML = `
          <div class="inline-flex items-center gap-4">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="pick-${g.GameId}" value="${g.Away}" class="accent-[var(--cfp-gold)]">
              <span>${g.Away}</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="pick-${g.GameId}" value="${g.Home}" class="accent-[var(--cfp-gold)]">
              <span>${g.Home}</span>
            </label>
          </div>
        `;
        tr.appendChild(tdPick);

        // Start
        const tdStart = document.createElement('td');
        tdStart.className = 'px-3 py-2 text-center';
        tdStart.textContent = niceTime(g['Start (CT)']);
        tr.appendChild(tdStart);

        // Line (read-only display here)
        const tdLine = document.createElement('td');
        tdLine.className = 'px-3 py-2 text-center';
        const ln = (typeof g.line === 'number') ? g.line : (g.line!=null ? Number(g.line) : null);
        tdLine.textContent = (ln!=null && !isNaN(ln)) ? (ln>0?`+${ln}`:`${ln}`) : '';
        tr.appendChild(tdLine);

        tbody.appendChild(tr);

        // Preselect to existing pick (if any)
        const chosen = picksMap[g.GameId] ?? '';
        const radios = tdPick.querySelectorAll(`input[name="pick-${g.GameId}"]`);
        if (chosen) {
          radios.forEach(r => { r.checked = (r.value === chosen); });
        }
        radios.forEach(r => r.addEventListener('change', e => {
          picksMap[g.GameId] = e.target.value || '';
        }));
      }
    }

    async function saveAllPicks(){
      const week = Number(weekSel.value);
      const teamId = Number(teamSel.value);
      if(!Number.isFinite(week) || !Number.isFinite(teamId)) return;

      saveBtn.disabled = true;
      status('Saving picks…');

      const payload = [];
      for (const g of gamesThisWeek) {
        const orig = (originalPicksMap[g.GameId] || '').trim() || null;
        const curr = (picksMap[g.GameId] || '').trim() || null;
        if (orig === curr) continue;
        if (curr === null) continue; // no selection: don't insert/update
        payload.push({ team_id: teamId, week, game_id: g.GameId, pick: curr });
      }

      if (payload.length === 0) {
        status('No pick changes to save.');
        saveBtn.disabled = false;
        return;
      }

      const { error } = await supabase
        .from('picks')
        .upsert(payload, { onConflict: 'team_id,week,game_id' });

      saveBtn.disabled = false;

      if(error){
        status(`Save failed: ${error.message}`, true);
      }else{
        status('Picks saved.');
        for (const row of payload) originalPicksMap[row.game_id] = row.pick;
      }
    }

    /* --------- Games Admin (which games are picked + lines) ---------- */
    async function refreshGamesAdmin(){
      const week = Number(weekSel.value);
      gamesTbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-gray-300">Loading games…</td></tr>`;

      const { data: rows, error } = await supabase
        .from('all_games')
        .select('GameId, Away, Home, "Start (CT)", line, picked, week')
        .eq('week', week)
        .order('GameId', { ascending: true });

      if(error){
        gamesTbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-red-300">${error.message}</td></tr>`;
        return;
      }

      adminGames = rows || [];
      adminPickedMap = {};
      adminLineMap = {};
      adminOriginalPickedMap = {};
      adminOriginalLineMap = {};

      for(const g of adminGames){
        adminPickedMap[g.GameId] = !!g.picked;
        adminLineMap[g.GameId] = (g.line==null || isNaN(Number(g.line))) ? null : Number(g.line);

        adminOriginalPickedMap[g.GameId] = adminPickedMap[g.GameId];
        adminOriginalLineMap[g.GameId] = adminLineMap[g.GameId];
      }

      renderGamesAdmin();
    }

    function renderGamesAdmin(){
      gamesTbody.innerHTML = '';
      if(!adminGames.length){
        gamesTbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-gray-300">No games found for this week.</td></tr>`;
        return;
      }

      for(const g of adminGames){
        const tr = document.createElement('tr');
        tr.className = 'border-t border-[rgba(231,231,231,.08)] hover:bg-[rgba(233,185,73,.04)]';

        // Game
        const tdGame = document.createElement('td');
        tdGame.className = 'px-4 py-2 font-medium text-[var(--cfp-ivory)]';
        tdGame.textContent = `${g.Away} @ ${g.Home}`;
        tr.appendChild(tdGame);

        // Start
        const tdStart = document.createElement('td');
        tdStart.className = 'px-3 py-2 text-center';
        tdStart.textContent = niceTime(g['Start (CT)']);
        tr.appendChild(tdStart);

        // Picked (checkbox)
        const tdPicked = document.createElement('td');
        tdPicked.className = 'px-3 py-2 text-center';
        const chkId = `picked-${g.GameId}`;
        tdPicked.innerHTML = `
          <input id="${chkId}" type="checkbox" class="switch" ${adminPickedMap[g.GameId] ? 'checked' : ''}>
        `;
        tr.appendChild(tdPicked);

        // Line (number input)
        const tdLine = document.createElement('td');
        tdLine.className = 'px-3 py-2 text-center';
        const lineId = `line-${g.GameId}`;
        const lineVal = adminLineMap[g.GameId];
        tdLine.innerHTML = `
          <input id="${lineId}" class="num-input rounded-none" type="number" step="0.5" placeholder="" ${adminPickedMap[g.GameId] ? '' : 'disabled'}
                 value="${lineVal!=null && !isNaN(lineVal) ? String(lineVal) : ''}">
        `;
        tr.appendChild(tdLine);

        gamesTbody.appendChild(tr);

        // wire up controls
        const chk = tdPicked.querySelector(`#${chkId}`);
        const lineInput = tdLine.querySelector(`#${lineId}`);

        chk.addEventListener('change', () => {
          adminPickedMap[g.GameId] = chk.checked;
          // enable/disable line when picked toggles
          lineInput.disabled = !chk.checked;
        });

        lineInput.addEventListener('input', () => {
          const v = lineInput.value.trim();
          adminLineMap[g.GameId] = (v === '' ? null : Number(v));
        });
      }
    }

    async function saveGamesAdmin(){
      const week = Number(weekSel.value);
      gamesSaveBtn.disabled = true;
      status('Saving games…');

      // Build diff payload (only changed rows)
      const payload = [];
      for(const g of adminGames){
        const id = g.GameId;
        const pickedOrig = adminOriginalPickedMap[id];
        const lineOrig = adminOriginalLineMap[id];
        const pickedCurr = !!adminPickedMap[id];
        const lineCurr = (adminLineMap[id]==null || isNaN(Number(adminLineMap[id]))) ? null : Number(adminLineMap[id]);

        const pickedChanged = pickedOrig !== pickedCurr;
        const lineChanged = (lineOrig ?? null) !== (lineCurr ?? null);

        if(!pickedChanged && !lineChanged) continue;

        // If unpicked, we still allow line to be null; if picked, line can be null (line optional).
        payload.push({
          GameId: id,
          week,
          picked: pickedCurr,
          line: lineCurr
        });
      }

      if(payload.length === 0){
        status('No game changes to save.');
        gamesSaveBtn.disabled = false;
        return;
      }

      // Upsert by primary key GameId (adjust onConflict if your PK differs)
      const { error } = await supabase
        .from('all_games')
        .upsert(payload, { onConflict: 'GameId' });

      gamesSaveBtn.disabled = false;

      if(error){
        status(`Save failed: ${error.message}`, true);
      }else{
        status('Games saved.');
        // Update originals and refresh picks section (since picked set may have changed)
        for(const row of payload){
          adminOriginalPickedMap[row.GameId] = row.picked;
          adminOriginalLineMap[row.GameId] = (row.line==null ? null : Number(row.line));
        }
        // Re-load both panels
        await refreshAll();
      }
    }

    // ---- run ----
    (async () => {
      const ok = await gatekeep();
      if(!ok) return;
      await bootstrap();
    })();
  </script>
</body>
</html>